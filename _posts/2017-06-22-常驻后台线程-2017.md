---
layout:     post
title:      "常驻后台线程"
subtitle:   "示例"
date:       2017-06-22 16:38:00
author:     "LeoHe"
header-img: "img/post-bg-2015.jpg"
tags:
    - Java
    - Android	
---

>一个常驻后台线程，用于处理消息循环
>
>用于运行算密集型人物、磁盘IO任务和执行时间小于1秒中的任务

```java
package com.dianping.util;

import android.os.Looper;

/**
 * 常驻的后台线程，用于处理一个消息循环
 * <p/>
 * 一般用于处理运算密集型任务、磁盘IO任务等执行时间小于1秒的任务
 *
 * @author Yimin
 */
public class Daemon {
    private static volatile boolean shouldStop;
    private static Thread thread = null;
    private static Looper looper = null;

    public static synchronized void start() {
        if (thread == null) {
            final BlockingItem<Looper> bl = new BlockingItem<Looper>();
            thread = new Thread(new Runnable() {
                @Override
                public void run() {
                    Looper.prepare();
                    Looper l = Looper.myLooper();
                    bl.put(l);

                    while (!shouldStop) {
                        try {
                            Looper.loop();
                        } catch (Exception e) {
                        }
                    }
                }
            }, "daemon");

            shouldStop = false;
            thread.start();
            try {
                looper = bl.take();
            } catch (InterruptedException e) {
            }
        }
    }

    public static synchronized void stop() {
        shouldStop = true;

        if (thread != null && looper != null) {
            looper.quit();
            try {
                thread.join();
            } catch (Exception e) {
            }
            thread = null;
            looper = null;
        }
    }

    public static Looper looper() {
        if (looper == null) {
            start();
        }
        return looper == null ? Looper.getMainLooper() : looper;
    }
}
```



```java
public class Test{
  private Handler daemonHandler = new Handler(Daemon.looper);
}
```





Handler +++++++Thread+++++++++Looper++++++++MessageQueue

TODO ：Android 线程通信，多线程，消息循环等概念+源码解读。

