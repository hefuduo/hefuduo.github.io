---
layout:     post
title:      "é¢å‘åˆ‡é¢ç¼–ç¨‹"
subtitle:   "AOPï¼ˆAspect Orient Programï¼‰"
date:       2017-02-27 11:09:00
author:     "LeoHe"
header-img: "img/post-bg-2015.jpg"
tags:
    - Java
    - ç¼–ç¨‹æ€æƒ³
    - è½¯ä»¶å·¥ç¨‹
---

[TOC]

# æ·±å…¥ç†è§£é¢å‘åˆ‡é¢ç¼–ç¨‹

> é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼šåœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€åœ°å°†ä»£ç åˆ‡å…¥åˆ°ç±»çš„åˆ¶å®šæ–¹æ³•ã€  æŒ‡å®šä½ç½®ä¸Šçš„ç¼–ç¨‹æ€æƒ³å°±æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚ä¸€èˆ¬è€Œè¨€ï¼šåˆ‡å…¥åˆ°åˆ¶å®šç±»åˆ¶å®šæ–¹æ³•çš„ä»£ç ç‰‡æ®µç§°ä¸ºåˆ‡é¢ï¼Œè€Œåˆ‡å…¥åˆ°å“ªäº›ç±»ã€å“ªäº›æ–¹æ³•åˆ™å«åˆ‡å…¥ç‚¹ã€‚æœ‰äº†è¿™ç§æ€æƒ³ï¼Œæˆ‘ä»¬å¯ä»¥å§å‡ ä¸ªç±»å…±æœ‰çš„ä»£ç ï¼ŒæŠ½å–åˆ°ä¸€ä¸ªåˆ‡ç‰‡ä¸­ï¼Œç­‰åˆ°éœ€è¦æ—¶å†åˆ‡å…¥å¯¹è±¡ä¸­å»ï¼Œä»è€Œæ”¹å˜å…¶åŸæœ‰çš„è¡Œä¸ºã€‚

## é¢å‘åˆ‡é¢ç¼–ç¨‹æ‰€è¦è§£å†³çš„é—®é¢˜ä»¥åŠåœ¨Springä¸­çš„å…·ä½“åº”ç”¨

> é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ˜¯å¯¹é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰çš„ä¸€ç§è¡¥å……ä¸å®Œå–„ï¼Œè€Œè¿™ç§æŠ€æœ¯æˆ–è€…æ˜¯æ€æƒ³åœ¨Spring IoCï¼ˆæˆ‘ä¹Ÿä¸æ‡‚æ˜¯ä»€ä¹ˆğŸ‘»ï¼‰ä¸­éå¸¸é‡è¦ï¼ŒSpringçš„ä¸€ä¸ªå…³é”®çš„ç»„ä»¶å°±æ˜¯AOPæ¡†æ¶ã€‚ä¸‹é¢ä¸€ä¸ªå°±æ˜¯Springä¸­ä½¿ç”¨AOPæŠ€æœ¯çš„æ‰€è§£å†³é—®é¢˜çš„å®ä¾‹ã€‚



â€‹        åœ¨ä¼ ç»Ÿçš„ç¼–å†™ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä¹ æƒ¯æ€§åœ°åšå‡ ä»¶äº‹æƒ…ï¼šæ—¥å¿—è®°å½•ã€äº‹åŠ¡æ§åˆ¶åŠæƒé™æ§åˆ¶ç­‰ï¼Œç„¶åæ‰æ˜¯ç¼–å†™æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç ã€‚å½“ä»£ç ç¼–å†™å®Œæˆå›å¤´å†çœ‹æ—¶ï¼Œä¸ç¦å‘ç°ï¼Œæ‰¬æ‰¬æ´’æ´’ä¸Šç™¾è¡Œä»£ç ä¸­ï¼ŒçœŸæ­£ç”¨äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¤„ç†æ‰é‚£ä¹ˆå‡ è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ–¹æ³•å¤æ–¹æ³•ï¼Œç±»å¤ç±»ï¼Œå°±è¿™æ ·å­å¸¦ç€æ— å¯å¥ˆä½•é—æ†¾åœ°åº¦è¿‡äº†å¤šå°‘ä¸ªæ˜¥ç§‹ã€‚è¿™å€’ä¹Ÿç½¢ï¼Œå€˜è‹¥åˆ°äº†é¡¹ç›®çš„å°¾å£°ï¼Œçªç„¶å†³å®šåœ¨æƒé™æ§åˆ¶ä¸Šéœ€è¦è¿›è¡Œå¤§çš„å˜åŠ¨æ—¶ï¼Œæˆåƒä¸Šä¸‡ä¸ªæ–¹æ³•åˆå¾—ä¸€ä¸€"ç™»é—¨æ‹œè®¿"ï¼Œç—›è‹¦"é›ªä¸ŠåŠ éœœ"ã€‚

![aspectJ1](/img/aspectJ/aspectJ1.jpg)

â€‹       å¦‚æœèƒ½æŠŠä¸Šå›¾æ‰€ç¤ºä¸­ä¼—å¤šæ–¹æ³•ä¸­çš„æ‰€æœ‰å…±æœ‰ä»£ç å…¨éƒ¨æŠ½å–å‡ºæ¥ï¼Œæ”¾ç½®åˆ°æŸä¸ªåœ°æ–¹é›†ä¸­ç®¡ç†ï¼Œç„¶ååœ¨å…·ä½“è¿è¡Œæ—¶ï¼Œå†ç”±å®¹å™¨åŠ¨æ€ç»‡å…¥è¿™äº›å…±æœ‰ä»£ç çš„è¯ï¼Œæœ€èµ·ç å¯ä»¥è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

[**Java EE**](http://lib.csdn.net/base/javaee)ç¨‹åºå‘˜åœ¨ç¼–å†™å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å¤„ç†æ–¹æ³•æ—¶ï¼Œåªéœ€å…³å¿ƒæ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ—¢æé«˜äº†å·¥ä½œæ•ˆç‡ï¼Œåˆä½¿ä»£ç å˜æ›´ç®€æ´ä¼˜é›…ã€‚

åœ¨æ—¥åçš„ç»´æŠ¤ä¸­ç”±äºä¸šåŠ¡é€»è¾‘ä»£ç ä¸å…±æœ‰ä»£ç åˆ†å¼€å­˜æ”¾ï¼Œè€Œä¸”å…±æœ‰ä»£ç æ˜¯é›†ä¸­å­˜æ”¾çš„ï¼Œå› æ­¤ä½¿ç»´æŠ¤å·¥ä½œå˜å¾—ç®€å•è½»æ¾ã€‚

é¢å‘åˆ‡é¢ç¼–ç¨‹AOPæŠ€æœ¯å°±æ˜¯ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜è€Œè¯ç”Ÿçš„ï¼Œåˆ‡é¢å°±æ˜¯æ¨ªåˆ‡é¢ï¼Œå¦‚å›¾6-5æ‰€ç¤ºï¼Œä»£è¡¨çš„æ˜¯ä¸€ä¸ªæ™®éå­˜åœ¨çš„å…±æœ‰åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæ—¥å¿—åˆ‡é¢ã€æƒé™åˆ‡é¢åŠäº‹åŠ¡åˆ‡é¢ç­‰ã€‚

![140615289](/img/aspectJ/140615289.jpg)



â€‹       ä¸‹é¢æˆ‘ä»¬ä»¥ç”¨æˆ·ç®¡ç†ä¸šåŠ¡é€»è¾‘ç»„ä»¶UserServiceçš„AOPå®ç°è¿‡ç¨‹ï¼ˆè§å›¾6-6ï¼‰ä¸ºä¾‹ï¼Œæ·±åº¦å‰–æä¸€ä¸‹AOPæŠ€æœ¯çš„å®ç°åŸç†ã€‚AOPæŠ€æœ¯æ˜¯å»ºç«‹åœ¨Javaè¯­è¨€çš„[åå°„æœºåˆ¶](http://www.cnblogs.com/lzq198754/p/5780331.html)ä¸[åŠ¨æ€ä»£ç†](http://www.2cto.com/kf/201609/546253.html)æœºåˆ¶ä¹‹ä¸Šçš„ã€‚ä¸šåŠ¡é€»è¾‘ç»„ä»¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒAOPå®¹å™¨ä¼šåŠ¨æ€åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ä¾›ä½¿ç”¨è€…è°ƒç”¨ï¼Œè¯¥ä»£ç†å¯¹è±¡å·²ç»æŒ‰Java EEç¨‹åºå‘˜çš„æ„å›¾å°†åˆ‡é¢æˆåŠŸåˆ‡å…¥åˆ°ç›®æ ‡æ–¹æ³•çš„è¿æ¥ç‚¹ä¸Šï¼Œä»è€Œä½¿åˆ‡é¢çš„åŠŸèƒ½ä¸ä¸šåŠ¡é€»è¾‘çš„åŠŸèƒ½åŒæ—¶å¾—ä»¥æ‰§è¡Œã€‚ä»åŸç†ä¸Šè®²ï¼Œè°ƒç”¨è€…ç›´æ¥è°ƒç”¨çš„å…¶å®æ˜¯AOPå®¹å™¨åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œå†ç”±ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡å¯¹è±¡å®ŒæˆåŸå§‹çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œè€Œä»£ç†å¯¹è±¡åˆ™å·²ç»å°†åˆ‡é¢ä¸ä¸šåŠ¡é€»è¾‘æ–¹æ³•è¿›è¡Œäº†åˆæˆã€‚

![140642106](/img/aspectJ/140642106.jpg)

åˆ‡é¢ï¼ˆAspectï¼‰ï¼šå…¶å®å°±æ˜¯å…±æœ‰åŠŸèƒ½çš„å®ç°ã€‚å¦‚æ—¥å¿—åˆ‡é¢ã€æƒé™åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ç­‰ã€‚åœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸æ˜¯ä¸€ä¸ªå­˜æ”¾å…±æœ‰åŠŸèƒ½å®ç°çš„æ™®é€šJavaç±»ï¼Œä¹‹æ‰€ä»¥èƒ½è¢«AOPå®¹å™¨è¯†åˆ«æˆåˆ‡é¢ï¼Œæ˜¯åœ¨é…ç½®ä¸­æŒ‡å®šçš„ã€‚

é€šçŸ¥ï¼ˆAdviceï¼‰ï¼šæ˜¯åˆ‡é¢çš„å…·ä½“å®ç°ã€‚ä»¥ç›®æ ‡æ–¹æ³•ä¸ºå‚ç…§ç‚¹ï¼Œæ ¹æ®æ”¾ç½®çš„åœ°æ–¹ä¸åŒï¼Œå¯åˆ†ä¸ºå‰ç½®é€šçŸ¥ï¼ˆBeforeï¼‰ã€åç½®é€šçŸ¥ï¼ˆAfterReturningï¼‰ã€å¼‚å¸¸é€šçŸ¥ï¼ˆAfterThrowingï¼‰ã€æœ€ç»ˆé€šçŸ¥ï¼ˆAfterï¼‰ä¸ç¯ç»•é€šçŸ¥ï¼ˆAroundï¼‰5ç§ã€‚åœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸æ˜¯åˆ‡é¢ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå…·ä½“å±äºå“ªç±»é€šçŸ¥ï¼ŒåŒæ ·æ˜¯åœ¨é…ç½®ä¸­æŒ‡å®šçš„ã€‚

è¿æ¥ç‚¹ï¼ˆJoinpointï¼‰ï¼šå°±æ˜¯ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢çš„åœ°ç‚¹ã€‚ä¾‹å¦‚ï¼Œæ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºæˆ–å­—æ®µä¿®æ”¹ç­‰ï¼Œä½†[**spring**](http://lib.csdn.net/base/javaee)åªæ”¯æŒæ–¹æ³•çº§çš„è¿æ¥ç‚¹ã€‚

åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰ï¼šç”¨äºå®šä¹‰é€šçŸ¥åº”è¯¥åˆ‡å…¥åˆ°å“ªäº›è¿æ¥ç‚¹ä¸Šã€‚ä¸åŒçš„é€šçŸ¥é€šå¸¸éœ€è¦åˆ‡å…¥åˆ°ä¸åŒçš„è¿æ¥ç‚¹ä¸Šï¼Œè¿™ç§ç²¾å‡†çš„åŒ¹é…æ˜¯ç”±åˆ‡å…¥ç‚¹çš„æ­£åˆ™è¡¨è¾¾å¼æ¥å®šä¹‰çš„ã€‚

ç›®æ ‡å¯¹è±¡ï¼ˆTargetï¼‰ï¼šå°±æ˜¯é‚£äº›å³å°†åˆ‡å…¥åˆ‡é¢çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯é‚£äº›è¢«é€šçŸ¥çš„å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ä¸­å·²ç»åªå‰©ä¸‹å¹²å¹²å‡€å‡€çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä»£ç äº†ï¼Œæ‰€æœ‰çš„å…±æœ‰åŠŸèƒ½ä»£ç ç­‰å¾…AOPå®¹å™¨çš„åˆ‡å…¥ã€‚

ä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šå°†é€šçŸ¥åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¹‹åè¢«åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡ã€‚å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œä»£ç†å¯¹è±¡çš„åŠŸèƒ½ç­‰äºç›®æ ‡å¯¹è±¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘åŠŸèƒ½åŠ ä¸Šå…±æœ‰åŠŸèƒ½ã€‚ä»£ç†å¯¹è±¡å¯¹äºä½¿ç”¨è€…è€Œè¨€æ˜¯é€æ˜çš„ï¼Œæ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„äº§ç‰©ã€‚

ç»‡å…¥ï¼ˆWeavingï¼‰ï¼šå°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å‘ç”Ÿåœ¨ç¼–è¯‘æœŸã€ç±»è£…è½½æœŸåŠè¿è¡ŒæœŸï¼Œå½“ç„¶ä¸åŒçš„å‘ç”Ÿç‚¹æœ‰ç€ä¸åŒçš„å‰ææ¡ä»¶ã€‚è­¬å¦‚å‘ç”Ÿåœ¨ç¼–è¯‘æœŸçš„è¯ï¼Œå°±è¦æ±‚æœ‰ä¸€ä¸ªæ”¯æŒè¿™ç§AOPå®ç°çš„ç‰¹æ®Šç¼–è¯‘å™¨ï¼›å‘ç”Ÿåœ¨ç±»è£…è½½æœŸï¼Œå°±è¦æ±‚æœ‰ä¸€ä¸ªæ”¯æŒAOPå®ç°çš„ç‰¹æ®Šç±»è£…è½½å™¨ï¼›åªæœ‰å‘ç”Ÿåœ¨è¿è¡ŒæœŸï¼Œåˆ™å¯ç›´æ¥é€šè¿‡Javaè¯­è¨€çš„åå°„æœºåˆ¶ä¸åŠ¨æ€ä»£ç†æœºåˆ¶æ¥åŠ¨æ€å®ç°ã€‚

## é¢å‘åˆ‡é¢ç¼–ç¨‹åœ¨Androidä¸­çš„åº”ç”¨

### ä¸“ä¸šæœ¯è¯­

Terminologyï¼š

Before we get started, let's have a look at some vocabulary that we should keep in mind:

- **Cross-cutting concerns:**Â Even though most classes in an OO model will perform a single, specific function, they often share common, secondary requirements with other classes.Â For example, we may want to add logging to classes within the data-access layer and also to classes in the UI layer whenever a thread enters or exits a method. Even though each class has a very different primary functionality, the code needed to perform the secondary functionality is often identical.
- **Advice:**Â The code that is injected to a class file. Typically we talk about before, after, and around advices, which are executed before, after, or instead of a target method. Itâ€™s possible to make also other changes than injecting code into methods, e.g. adding fields or interfaces to a class.Â 
- **Join point:**Â A particular point in a program that might be the target of code injection, e.g. a method call or method entry.
- **Pointcut:**Â An expression which tells a code injection tool where to inject a particular piece of code, i.e. to which joint points to apply a particular advice. It could select only a single such point â€“ e.g. execution of a single method â€“ or many similar points â€“ e.g. executions of all methods marked with a custom annotation such as @DebugTrace.
- **Aspect:**Â The combination of the pointcut and the advice is termed an aspect. For instance, we add a logging aspect to our application by defining a pointcut and giving the correct advice.
- **Weaving:Â **The process of injecting code â€“ advices â€“ into the target places â€“ joint points.

This picture summarizes a bit a few of these concepts:

![AspectOrientedProgramming](/img/aspectJ/AspectOrientedProgramming.png)

### åœ¨Androidä¸­ï¼Œåœ¨å“ªäº›åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨AOPï¼Ÿ

1. æ—¥å¿—
2. æŒä¹…åŒ–
3. æ€§èƒ½ç›‘æ§
4. æ•°æ®è®¤è¯
5. ç¼“å­˜
6. æ¯”æ–¹è¯´åŸ‹ç‚¹

é‚£ä¹ˆï¼Œè¿™äº›ä»£ç å¯ä»¥åœ¨ä¸åŒçš„æ—¶æœŸæ³¨å…¥ï¼š

1. runtimeï¼šè¿è¡Œæ—¶æ³¨å…¥ã€‚ä¾‹å¦‚åŠ¨æ€ä»£ç†ã€‚
2. load-timeï¼šç±»è£…è½½æ—¶æ³¨å…¥ã€‚è¿™äº›ä¿®æ”¹å¯ä»¥åœ¨ç›®æ ‡classesæ­£åœ¨è¢«Dalvikæˆ–è€…ARTè½½å…¥æ—¶ï¼Œä¿®æ”¹ã€‚ByteCodeæˆ–DexCode weavingã€‚
3. build-timeï¼šç¼–è¯‘æ—¶æ³¨å…¥ã€‚åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­åŠ å…¥å…¶å®ƒæ­¥éª¤ï¼Œåœ¨æ‰“åŒ…æˆ–è€…å‘å¸ƒåº”ç”¨å‰ï¼Œæ¥ä¿®æ”¹æœ€ç»ˆç¼–è¯‘å‡ºçš„ç»“æœã€‚SourceCode weavingã€‚



### å·¥å…·å’Œåº“

1. **AspectJ** ï¼šä¸€ä¸ªå¯ä»¥å’ŒJavaå¹³å°æ— ç¼è¿æ¥çš„AOPæ‰©å±•åº“ï¼Œå…¼å®¹Androidï¼ŒAspectJæœ‰ç€è‡ªå·±çš„è¯­æ³•ã€‚ï¼ˆè¿è¡Œåœ¨JVMä¸Šçš„å…¼å®¹Javaçš„è¯­è¨€ï¼‰ã€‚
2. **Javassit for Android**ï¼šäºŒè¿›åˆ¶ä»£ç æ“ä½œåº“ã€‚
3. **DexMaker**ï¼šä¸€ä¸ªJavaè¿è¡Œæ—¶æˆ–ç¼–è¯‘æ—¶äº§ç”ŸDalvikè™šæ‹Ÿæœºç›®æ ‡ä»£ç çš„å·¥å…·ã€‚
4. **ASMDEX**ï¼šäºŒè¿›åˆ¶ä»£ç æ“ä½œåº“ã€‚



### ä¸ºä»€ä¹ˆä½¿ç”¨AspectJ

* éå¸¸å¼ºå¤§
* æ”¯æŒç¼–è¯‘æ—¶å’Œç±»åŠ è½½æ—¶ä»£ç æ³¨å…¥
* ä½¿ç”¨ç®€å•



### å®ä¾‹

å‡å¦‚æˆ‘ä»¬æƒ³æµ‹é‡ä¸€ä¸ªæ–¹æ³•çš„æ€§èƒ½ï¼ˆæ‰§è¡Œæ—¶é—´ï¼‰ã€‚ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬æ ‡è®°å‡½æ•°ä½¿ç”¨**@DebugTrace**è¿™ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”å¸Œæœ›ä½¿ç”¨logcatè·å¾—ç»“æœï¼Œå¹¶ä¸”ä¸ç”¨åœ¨æ¯ä¸ªæ³¨è§£çš„æ–¹æ³•ä¸­å†™ä»£ç ã€‚**ä½¿ç”¨AspectJæ¥å®ç°è¿™ä¸ªç›®æ ‡**

![AspectWeaving](/img/aspectJ/AspectWeaving.png)

<p color="green">Project Structure</p>



**åˆ›å»ºæ³¨è§£**

```java
@Retention(RetentionPolicy.CLASS)
@Target({ElementType.CONSTRUCTOR, ElementType.METHOD})
public @interface DebugTrace{
  
}
```

**åˆ›å»ºStopWatchç±»æ¥ç›‘æ§æ€§èƒ½**

```java
//StopWatch.class
public class StopWatch {
  private long startTime;
  private long endTime;
  private long elapsedTime;

  public StopWatch() {
    //empty
  }

  private void reset() {
    startTime = 0;
    endTime = 0;
    elapsedTime = 0;
  }

  public void start() {
    reset();
    startTime = System.nanoTime();
  }

  public void stop() {
    if (startTime != 0) {
      endTime = System.nanoTime();
      elapsedTime = endTime - startTime;
    } else {
      reset();
    }
  }

  public long getTotalTimeMillis() {
    return (elapsedTime != 0) ? TimeUnit.NANOSECONDS.toMillis(endTime - startTime) : 0;
  }
}
```

**DebugLog Class**

```java
/**
 * Wrapper around {@link android.util.Log}
 */
public class DebugLog {

  private DebugLog() {}

  /**
   * Send a debug log message
   *
   * @param tag Source of a log message.
   * @param message The message you would like logged.
   */
  public static void log(String tag, String message) {
    Log.d(tag, message);
  }
}
```

**Our Aspect**

> managing the annotation processing and source-code weaving.

**TraceAspect.java**

```java
/**
 * Aspect representing the cross cutting-concern: Method and Constructor Tracing.
 */
@Aspect
public class TraceAspect {

  private static final String POINTCUT_METHOD =
      "execution(@org.android10.gintonic.annotation.DebugTrace * *(..))";

  private static final String POINTCUT_CONSTRUCTOR =
      "execution(@org.android10.gintonic.annotation.DebugTrace *.new(..))";

  @Pointcut(POINTCUT_METHOD)
  public void methodAnnotatedWithDebugTrace() {}

  @Pointcut(POINTCUT_CONSTRUCTOR)
  public void constructorAnnotatedDebugTrace() {}

  @Around("methodAnnotatedWithDebugTrace() || constructorAnnotatedDebugTrace()")
  public Object weaveJoinPoint(ProceedingJoinPoint joinPoint) throws Throwable {
    MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature();
    String className = methodSignature.getDeclaringType().getSimpleName();
    String methodName = methodSignature.getName();

    final StopWatch stopWatch = new StopWatch();
    stopWatch.start();
    Object result = joinPoint.proceed();
    stopWatch.stop();

    DebugLog.log(className, buildLogMessage(methodName, stopWatch.getTotalTimeMillis()));

    return result;
  }

  /**
   * Create a log message.
   *
   * @param methodName A string with the method name.
   * @param methodDuration Duration of the method in milliseconds.
   * @return A string representing message.
   */
  private static String buildLogMessage(String methodName, long methodDuration) {
    StringBuilder message = new StringBuilder();
    message.append("Gintonic --> ");
    message.append(methodName);
    message.append(" --> ");
    message.append("[");
    message.append(methodDuration);
    message.append("ms");
    message.append("]");

    return message.toString();
  }
}
```

 **åœ¨Androidé¡¹ç›®ä¸­ä½¿ç”¨AspectJ**

éœ€è¦é…ç½®ä¸€ä¸‹Gradleï¼Œä½¿å¾—ä½¿ç”¨AspectJ compileræ¥ç¼–è¯‘æ‰€æœ‰è¢«AspectJæ‰€å½±å“çš„classesã€‚

**build.gradle** 

```groovy
import com.android.build.gradle.LibraryPlugin
import org.aspectj.bridge.IMessage
import org.aspectj.bridge.MessageHandler
import org.aspectj.tools.ajc.Main

buildscript {
  repositories {
    mavenCentral()
  }
  dependencies {
    classpath 'com.android.tools.build:gradle:0.12.+'
    classpath 'org.aspectj:aspectjtools:1.8.1'
  }
}

apply plugin: 'android-library'

repositories {
  mavenCentral()
}

dependencies {
  compile 'org.aspectj:aspectjrt:1.8.1'
}

android {
  compileSdkVersion 19
  buildToolsVersion '19.1.0'

  lintOptions {
    abortOnError false
  }
}

android.libraryVariants.all { variant ->
  LibraryPlugin plugin = project.plugins.getPlugin(LibraryPlugin)
  JavaCompile javaCompile = variant.javaCompile
  javaCompile.doLast {
    String[] args = ["-showWeaveInfo",
                     "-1.5",
                     "-inpath", javaCompile.destinationDir.toString(),
                     "-aspectpath", javaCompile.classpath.asPath,
                     "-d", javaCompile.destinationDir.toString(),
                     "-classpath", javaCompile.classpath.asPath,
                     "-bootclasspath", plugin.project.android.bootClasspath.join(
        File.pathSeparator)]

    MessageHandler handler = new MessageHandler(true);
    new Main().run(args, handler)

    def log = project.logger
    for (IMessage message : handler.getMessages(null, true)) {
      switch (message.getKind()) {
        case IMessage.ABORT:
        case IMessage.ERROR:
        case IMessage.FAIL:
          log.error message.message, message.thrown
          break;
        case IMessage.WARNING:
        case IMessage.INFO:
          log.info message.message, message.thrown
          break;
        case IMessage.DEBUG:
          log.debug message.message, message.thrown
          break;
      }
    }
  }
}
```

**æµ‹è¯•æ–¹æ³•**

```java
@DebugTrace
  private void testAnnotatedMethod() {
    try {
      Thread.sleep(10);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }


//outputs:
//will like this:
//Gintonic --> testAnnotatedMethod --> [10ms]
```





#  AspectJä»‹ç»

> AspectJæ˜¯ä¸€ç§è¯­è¨€ï¼Œä½†æ˜¯å…¶ä¹Ÿè¿è¡Œåœ¨JVMä¹‹ä¸Šï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯JVMç±»è¯­è¨€çš„ä¸€ç§ï¼Œç±»ä¼¼Scalaä¹‹ç±»çš„ã€‚AspectJä¹Ÿæ”¯æŒåŸç”ŸJavaï¼Œåªè¦æ˜¯ç”¨AspectJæä¾›çš„æ³¨è§£å°±å¥½äº†ã€‚
>
> ä½†æ˜¯ä¸ç®¡ç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œæœ€ç»ˆå€’è¦ç”¨ajcæ¥ç¼–è¯‘ã€‚

1.Joint Points

Joint Pointsï¼ˆ*JPoints* for shortï¼‰æ˜¯AspectJä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µã€‚å°±æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„ä¸€äº›æ‰§è¡Œç‚¹ã€‚ï¼ˆæˆ‘çš„ç†è§£å°±æ˜¯ç±»ä¼¼äºè°ƒè¯•æ—¶çš„æ–­ç‚¹ã€‚ï¼‰

- ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨å¯ä»¥æ˜¯ä¸€ä¸ªJPoint
- è®¾ç½®æˆ–åˆ™è¯»å–ä¸€ä¸ªå˜é‡ä¹Ÿæ˜¯ä¸€ä¸ªJPoint
- forå¾ªç¯ä¹Ÿå¯ä»¥çœ‹åšæ˜¯JPoint

ç†è®ºä¸Šï¼Œä¸€ä¸ªç¨‹åºä¸­å¾ˆå¤šåœ°æ–¹éƒ½å¯ä»¥è¢«çœ‹åšæ˜¯ä¸€ä¸ªJPointï¼Œä½†æ˜¯AspectJä¸­æ˜ç¡®è§„å®šäº†åªæœ‰ä¸‹è¡¨ä¸­çš„è¿™äº›æ‰§è¡Œç‚¹è®¤ä¸ºæ˜¯JPoints

| Joint Points          | è¯´æ˜               | å®ä¾‹               |
| :-------------------- | :--------------- | :--------------- |
| method call           | å‡½æ•°è°ƒç”¨             | Log.e()          |
| method execution      | å‡½æ•°æ‰§è¡Œ             | æ¯”å¦‚Log.e()æ‰§è¡Œå†…éƒ¨    |
| constructor call      | æ„é€ å‡½æ•°è°ƒç”¨           | å‡½æ•°è°ƒç”¨ç±»ä¼¼           |
| constructor execution | å’Œå‡½æ•°æ‰§è¡Œç±»ä¼¼          | å‡½æ•°æ‰§è¡Œç±»ä¼¼           |
| field get             | è·å–æŸä¸ªå˜é‡           |                  |
| field set             | è®¾ç½®æŸä¸ªå˜é‡           |                  |
| pre-initialization    | Objectåœ¨æ„é€ å‡½æ•°ä¸­åšçš„å·¥ä½œ |                  |
| static initializaiton | ç±»åˆå§‹åŒ–             | é™æ€åˆå§‹åŒ–ä»£ç å—         |
| handler               | å¼‚å¸¸å¤„ç†             | trycatchä¸­çš„catchå— |
| advice execution      | AspectJå†…å®¹        |                  |
|                       |                  |                  |

ä¸€ä¸ªæ¯”è¾ƒç›´è§‚ä¸€ç‚¹çš„ä¾‹å­ï¼š

åˆ©ç”¨Intelij IDEAåˆ›å»ºä¸€ä¸ªç®€å•çš„Java console Applicationï¼Œéœ€è¦AspectJçš„ä¸¤ä¸ªæ’ä»¶ï¼ˆå…·ä½“å¯å‚è€ƒIDEçš„å¸®åŠ©æ‰‹å†Œï¼‰ï¼Œ

æ–°å»ºTest.javaï¼Œä¸JPTest.ajï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```java
/**
 * Created by hefuduo on 2017/3/15.
 */

public class Test {
    static public class TestBase {
        static int x = 0;
        int base = 0;

        TestBase(int index) {
            base = index;
        }
    }

    static public class TestDerived extends TestBase {
        public int derived = 0;

        TestDerived() {
            super(0);
            this.derived = 1000;
        }

        public void testMethod() {
            try {
                byte[] test = null;
                test[1] = 0x33;
            } catch (Exception e) {

            }
        }

        static int getFixedIndex() {
            return 1000;
        }
    }

    public static void main(String args[]) {
        System.out.println("Test begin ...");
        TestDerived derived = new TestDerived();
        derived.testMethod();
        derived.base = 1;
        System.out.println("Test end...");
    }

}

```



```java
import org.aspectj.lang.Signature;
import org.aspectj.lang.reflect.ConstructorSignature;

/**
 * Created by hefuduo on 2017/3/15.
 */
public aspect JPTest {
    pointcut testAll():within(Test);
    before():testAll(){
        System.out.println("before calling " + thisJoinPoint);
        System.out.println("     at:  " + thisJoinPoint.getSourceLocation());
    }

    after():testAll(){
        Signature sig = thisJoinPoint.getSignature();
        if(sig instanceof ConstructorSignature){
            System.out.println("after calling: " + thisJoinPoint);
            System.out.println("      at: " + thisJoinPoint.getSourceLocation());
        }
    }
}
```

ç„¶åé…ç½®Configurationï¼ˆåŒ…æ‹¬compiler å°†é¡¹ç›®çš„compilerè®¾ç½®ä¸ºajcï¼‰ã€‚

æœ€åå°†ç¼–è¯‘å¥½çš„ç¨‹åºè¿è¡Œï¼Œå³å¯å¾—åˆ°ç»“æœã€‚å¯ä»¥å°è¯•å°†Aspectç±»æ·»åŠ ä¸€ä¸ªç©ºçš„mainæ–¹æ³•ï¼

2.Pointcuts

ä¸€ä¸ªç¨‹åºä¼šæœ‰å¾ˆå¤šJPointsï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªå‡½æ•°ä¹Ÿä¼šåˆ†callç±»å‹å’Œexecutionç±»å‹ã€‚æ˜¾ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„JPointï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰ç±»å‹çš„JPointæ˜¯æˆ‘ä»¬æ‰€å…³æ³¨çš„ï¼Œä¸¾ä¾‹Activityçš„å‡ ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­æ‰“å°æ—¥å¿—ï¼Œåªæœ‰è¿™å‡ ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°æ‰æ˜¯æˆ‘ä»¬ä¸šåŠ¡éœ€è¦çš„JPointï¼Œè€Œå…¶ä»–çš„ä»€ä¹ˆJPointæˆ‘ä¸éœ€è¦å…³æ³¨ï¼Œæ€ä¹ˆä»ä¸€å †ä¸€å †çš„JPointsä¸­é€‰æ‹©è‡ªå·±æƒ³è¦çš„JPointså‘¢ï¼ŸPointcutså°±æ˜¯ç”¨æ¥è¿‡æ»¤JPointsçš„ã€‚ä»¥ä¸‹ä¸¾ä¾‹è¯´æ˜ã€‚

```tiddlywiki
//ä»¥ä¸Šç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š
before calling staticinitialization(Test.<clinit>)
     at:  Test.java:0
before calling execution(void Test.main(String[]))
     at:  Test.java:37
before calling get(PrintStream java.lang.System.out)
     at:  Test.java:38
before calling call(void java.io.PrintStream.println(String))
     at:  Test.java:38
Test begin ...
before calling call(Test.TestDerived())
     at:  Test.java:39
before calling staticinitialization(Test.TestBase.<clinit>)
     at:  Test.java:7
before calling set(int Test.TestBase.x)
     at:  Test.java:7
before calling staticinitialization(Test.TestDerived.<clinit>)
     at:  Test.java:0
before calling preinitialization(Test.TestDerived())
     at:  Test.java:18
after calling: preinitialization(Test.TestDerived())
      at: Test.java:18
before calling preinitialization(Test.TestBase(int))
     at:  Test.java:10
after calling: preinitialization(Test.TestBase(int))
      at: Test.java:10
before calling initialization(Test.TestBase(int))
     at:  Test.java:10
before calling execution(Test.TestBase(int))
     at:  Test.java:10
before calling set(int Test.TestBase.base)
     at:  Test.java:8
before calling set(int Test.TestBase.base)
     at:  Test.java:11
after calling: execution(Test.TestBase(int))
      at: Test.java:10
after calling: initialization(Test.TestBase(int))
      at: Test.java:10
before calling initialization(Test.TestDerived())
     at:  Test.java:18
before calling execution(Test.TestDerived())
     at:  Test.java:18
before calling set(int Test.TestDerived.derived)
     at:  Test.java:16
before calling set(int Test.TestDerived.derived)
     at:  Test.java:20
after calling: execution(Test.TestDerived())
      at: Test.java:18
after calling: initialization(Test.TestDerived())
      at: Test.java:18
after calling: call(Test.TestDerived())
      at: Test.java:39
before calling call(void Test.TestDerived.testMethod())
     at:  Test.java:40
before calling execution(void Test.TestDerived.testMethod())
     at:  Test.java:23
before calling handler(catch(Exception))
     at:  Test.java:27
before calling set(int Test.TestBase.base)
     at:  Test.java:41
before calling get(PrintStream java.lang.System.out)
     at:  Test.java:42
before calling call(void java.io.PrintStream.println(String))
     at:  Test.java:42
Test end...
```

å¼•ç”³ä¸ºä¸€å¥è¯å°±æ˜¯ï¼ŒPointcutsçš„ç›®çš„æ˜¯æä¾›ä¸€ç§æ–¹æ³•ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿé€‰æ‹©è‡ªå·±æ„Ÿå…´è¶£çš„JoinPointsã€‚ä¸‹é¢å°±ä»ç®€å…¥ç¹çš„ç†è§£Pointcutsã€‚

ç»è¿‡ä¿®æ”¹åï¼ˆæˆ‘ä»¬æ¢ä¸€ç§è¿‡æ»¤çš„ç­–ç•¥ï¼‰çš„ä»£ç æ˜¯é…±å©¶çš„ï¼š

```java
import org.aspectj.lang.Signature;
import org.aspectj.lang.reflect.ConstructorSignature;

/**
 * Created by hefuduo on 2017/3/15.
 */
public aspect JPTest {
  //pointcutï¼šå…³é”®è¯ï¼Œè¡¨ç¤ºè¿™é‡Œå®šä¹‰çš„æ˜¯ä¸€ä¸ªpointcutã€‚
  //testAll()pointcutçš„åå­—ï¼Œåœ¨AspectJä¸­ï¼Œå®šä¹‰Pointcutå¯ä»¥åˆ†ä¸ºæœ‰åå’ŒåŒ¿åä¸¤ç§åŠæ³•ã€‚å»ºè®®ä½¿ç”¨æœ‰åå­—çš„æ–¹æ³•ã€‚
  //åˆ‡ç‚¹åç§°åçš„å†’å·ï¼Œæ˜¯å¿…é¡»åŠ ä¸Šçš„ï¼Œå†’å·åé¢æ˜¯è¿™ä¸ªpointcutæ€ä¹ˆé€‰æ‹©JoinPointçš„æ¡ä»¶ã€‚æœ¬ä¾‹å­ä¸­çš„æ¡ä»¶ç¿»è¯‘ä¸ºï¼šé€‰æ‹©é‚£äº›è°ƒç”¨println(ä»»æ„ä¸ªå‚æ•°)çš„Joinpointï¼ŒTestAspectä¸­çš„é™¤å¤–ã€‚
  
 /**
 * call : ä¸€ç§é€‰æ‹©æ¡ä»¶ï¼Œä¸ºcallå‡½æ•°è°ƒç”¨ç±»å‹
 * (public * *.println(..)) =  ([modifier] [return pattern] [function named println in package] ([param pattern])
 *callåé¢å¯ä»¥ç”¨ä¸æˆ–éç»„åˆæ¡ä»¶ã€‚
 *withinæ˜¯å¦å¤–ä¸€ç§ç±»å‹é€‰æ‹©æ–¹æ³•ï¼Œç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ç±»å‹å’Œå‰é¢è®²åˆ°çš„joinpointçš„å“ªå‡ ç§ç±»å‹ä¸åŒã€‚withinçš„ç±»å‹æ˜¯æ•°æ®ç±»å‹ï¼Œè€Œjoinpointçš„ç±»å‹æ›´åƒæ˜¯åŠ¨æ€çš„ï¼Œè¿è¡Œæ—¶çš„ç±»å‹ã€‚ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ
 */  
    pointcut testAll():call(public * *.println(..)) && !within(JPTest);
    before():testAll(){
        System.out.println("before calling " + thisJoinPoint);
        System.out.println("     at:  " + thisJoinPoint.getSourceLocation());
    }

    after():testAll(){
        Signature sig = thisJoinPoint.getSignature();
        if(sig instanceof ConstructorSignature){
            System.out.println("after calling: " + thisJoinPoint);
            System.out.println("      at: " + thisJoinPoint.getSourceLocation());
        }
    }
}

```

ç»è¿‡ä¿®æ”¹åçš„æ‰§è¡Œç»“æœæ˜¯é…±å©¶çš„ï¼š

```java
before calling call(void java.io.PrintStream.println(String))
     at:  Test.java:38
Test begin ...
before calling call(void java.io.PrintStream.println(String))
     at:  Test.java:42
Test end...
```

é‚£ä¹ˆç»è¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œæ‰©å±•ä¸€ä¸‹å“ï¼Œå°±æœ‰äº†ä¸‹é¢çš„è¡¨ï¼š

~ç›´æ¥å¯¹JoinPointçš„é€‰æ‹©

| Join point category         | Pointcut syntax                         |
| --------------------------- | --------------------------------------- |
| method execution            | execution(MethodSignature)              |
| method call                 | call(MethodSignature)                   |
| constructor execution       | execution(ConstructorSignature)         |
| constructor call            | call(ConstructorSignature)              |
| class initialization        | staticinitialization(TypeSignature)     |
| Field read access           | get(FiledSignature)                     |
| Field write access          | set(FieldSignature)                     |
| Exception handler execution | handler(TypeSignature)                  |
| object initialization       | initializaiton(ConstructorSignature)    |
| object pre-initialization   | preinitialization(ConstructorSignature) |
| Advice execution            | adviceexcution()                        |

~é—´æ¥é’ˆå¯¹JPointçš„é€‰æ‹©

é™¤äº†ä½¿ç”¨Signatureä¿¡æ¯åŒ¹é…JPointå¤–ï¼ŒAspectJè¿˜æä¾›å…¶ä»–ä¸€äº›é€‰æ‹©æ–¹æ³•æ¥é€‰æ‹©JPointï¼Œæ¯”å¦‚æŸä¸ªç±»ä¸­çš„æ‰€æœ‰JPointï¼Œæ¯ä¸€ä¸ªå‡½æ•°æ‰§è¡Œæµç¨‹ä¸­æ‰€åŒ…å«çš„JPoint

ä»¥ä¸‹åˆ—ä¸¾å‡ºäº†ä¸€äº›å¸¸ç”¨çš„éJPointé€‰æ‹©æ–¹æ³•ï¼š

| å…³é”®è¯                            | è¯´æ˜                                       | å®ä¾‹                                       |
| ------------------------------ | ---------------------------------------- | ---------------------------------------- |
| within(TypePattern)            | TypePatternè¡¨ç¤ºpackageæˆ–è€…ç±»ï¼Œå¯ä½¿ç”¨é€šé…ç¬¦           | è¡¨ç¤ºæŸä¸ªpackageæˆ–è€…å‹’ç§çš„æ‰€æœ‰JPointä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­          |
| withincode(fucntion Signature) | è¡¨ç¤ºæŸä¸ªæ„é€ å‡½æ•°æˆ–è€…å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠçš„JPoint               | withinCode(* TestDerived.testMethod(...))è¡¨ç¤ºtestMethodæ¶‰åŠçš„JPointï¼Œwithincode(*.Test.new(..))è¡¨ç¤ºTestæ„é€ å‡½æ•°æ¶‰åŠçš„JPoint |
| cflow                          | cflowæ˜¯call flowçš„æ„æ€ï¼Œcflowçš„æ¡ä»¶æ˜¯pointcut     | cflow(call TestDerived.testMethod)è¡¨ç¤ºè°ƒç”¨TestDerived.testMethodå‡½æ•°æ—¶æ‰€åŒ…å«çš„JPointï¼ŒåŒ…æ‹¬testMethodcçš„callè¿™ä¸ªJPointæœ¬èº«ã€‚ |
| cfowbelow                      |                                          | cflowbelow(call TestDerived.testMethod)ï¼šè¡¨ç¤ºè°ƒç”¨TestDerived.testMethodå‡½æ•°æ—¶æ‰€åŒ…å«çš„JPointï¼Œ*ä¸*åŒ…æ‹¬testMethodcçš„callè¿™ä¸ªJPointæœ¬èº«ã€‚ |
| this(Type)                     | JPointçš„thiså¯¹è±¡æ˜¯Typeç±»å‹ã€‚åˆ¤æ–­Typeæ˜¯ä¸æ˜¯æŸç§ç±»å‹ï¼Œå³æ˜¯å¦æ»¡è¶³instanceofTypeçš„æ¡ä»¶ | JPointæ˜¯ä»£ç æ®µï¼ˆä¸è®ºæ˜¯å‡½æ•°ï¼Œå¼‚å¸¸å¤„ç†ï¼Œstatic blockï¼‰ï¼Œä»è¯­æ³•ä¸Šè¯´ï¼Œå®ƒéƒ½å±äºä¸€ä¸ªç±»ã€‚å¦‚æœè¿™ä¸ªç±»çš„ç±»å‹æ˜¯Typeæ ‡ç¤ºçš„ç±»å‹ï¼Œåˆ™å’Œå®ƒç›¸å…³çš„JPointå°†å…¨éƒ¨è¢«é€‰ä¸­ã€‚å›¾2ç¤ºä¾‹çš„testMethodæ˜¯TestDerivedç±»ã€‚æ‰€ä»¥this(TestDerived)å°†ä¼šé€‰ä¸­è¿™ä¸ªtestMethod JPoint |
| target(Type)                   | JPointçš„targetå¯¹è±¡æ˜¯Typeç±»å‹                   | å’Œthisç›¸å¯¹çš„æ˜¯targetã€‚ä¸è¿‡targetä¸€èˆ¬ç”¨åœ¨callçš„æƒ…å†µã€‚callä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯èƒ½å®šä¹‰åœ¨å…¶ä»–ç±»ã€‚æ¯”å¦‚testMethodæ˜¯TestDerivedç±»å®šä¹‰çš„ã€‚é‚£ä¹ˆ arget(TestDerived)å°±ä¼šæœç´¢åˆ°è°ƒç”¨testMethodçš„åœ°æ–¹ã€‚ä½†æ˜¯ä¸åŒ…æ‹¬testMethodçš„execution JPoint |
| args(TypeSignature)            | ç”¨æ¥å¯¹JPointçš„å‚æ•°è¿›è¡Œæ¡ä»¶æœç´¢çš„                      | æ¯”å¦‚args(int,..)ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°æ˜¯intï¼Œåé¢å‚æ•°ä¸ªæ•°å’Œç±»å‹ä¸é™çš„JPoint |

**æ³¨æ„ï¼šthis()å’Œtarget()åŒ¹é…çš„æ—¶å€™ä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ã€‚**

**æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„AOPå®ç°éƒ½æ”¯æŒæœ¬èŠ‚æ‰€è¯´çš„æŸ¥è¯¢æ¡ä»¶ã€‚æ¯”å¦‚Springå°±ä¸æ”¯æŒwithincodeæŸ¥è¯¢æ¡ä»¶**



Adviceå’ŒAspectJ

> åœ¨AspectJä¸­ï¼Œåœ¨pointcutså‰åæ‰§è¡Œçš„ä»£ç ï¼Œè¿™æ®µä»£ç å°±å«åšadviceã€‚
>
> ç®€å•æ¥è¯´ï¼Œadviceå°±æ˜¯ä¸€ç§hookã€‚
>
> é‚£ä»€ä¹ˆæ˜¯hookå‘¢ï¼Œhookè¿™ä¸ªæ¥æºäºwindowsï¼Œwin32ç¨‹åºéƒ½æ˜¯åŸºäºæ¶ˆæ¯å¾ªç¯æœºåˆ¶çš„ï¼Œçª—å£æ¥æ”¶é¼ æ ‡é”®ç›˜äº‹ä»¶ï¼Œè€Œhookå°±æ˜¯åœ¨çª—å£ä¹‹å‰æ‹¦æˆªä½è¿™äº›äº‹ä»¶ï¼Œåšä¸€äº›å¤„ç†ï¼Œå°±åƒæ˜¯ä¸ªé’©å­ä¸€æ ·ã€‚å‹¾ä½äº‹ä»¶ï¼Œæ‰§è¡Œè‡ªå·±çš„ä»£ç ã€‚

AspectJä¸­æœ‰å¥½å‡ ä¸ªHookï¼Œä¸»è¦æ˜¯æ ¹æ®JPointæ‰§è¡Œæ—¶æœºçš„ä¸åŒè€Œä¸åŒã€‚

ä¸‹è¡¨ä¸­åˆ—ä¸¾å‡ºäº†AspectJæ‰€æ”¯æŒçš„Adviceçš„ç±»å‹ã€‚

| å…³é”®è¯                      | è¯´æ˜                                       | ä½œç”¨                                       |
| ------------------------ | ---------------------------------------- | ---------------------------------------- |
| before()                 | before advice                            | è¡¨ç¤ºåœ¨JPointæ‰§è¡Œä¹‹å‰ï¼Œåšä¸€äº›äº‹æƒ…                      |
| after()                  | after advice                             | è¡¨ç¤ºåœ¨JPointæ‰§è¡Œä¹‹åï¼Œåšä¸€äº›äº‹æƒ…                      |
| after():returning(è¿”å›å€¼ç±»å‹) | returningå’Œthrowingåé¢éƒ½å¯ä»¥æŒ‡å®šå…·ä½“çš„ç±»å‹ï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯åˆ™åŒ¹é…æ—¶å€™ä¸é™å®šç±»å‹ | å¦‚æœJPointæ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„è¯ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨æ‰§è¡Œå®Œæœ‰ä¸¤ç§æ–¹å¼é€€å‡ºï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸çš„returnï¼Œå¦ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ |
| after():throwing(å¼‚å¸¸ç±»å‹)   |                                          | after()é»˜è®¤åŒ…æ‹¬returningå’Œthrowingä¸¤ç§æƒ…å†µ        |
| è¿”å›å€¼ç±»å‹around()            | beforeå’Œaroundæ˜¯æŒ‡JPointæ‰§è¡Œå‰æˆ–æ‰§è¡Œåè¢«å¤„ç½šï¼Œè€Œaroundå°±æ›¿ä»£äº†å…ƒJPoint | aroundæ˜¯æ›¿ä»£äº†åŸJPointï¼Œå¦‚æœè¦æ‰§è¡ŒåŸJPointçš„è¯ï¼Œéœ€è¦è°ƒç”¨proceed |

**æ³¨æ„ï¼Œafterå’Œbiforeæ²¡æœ‰è¿”å›å€¼ï¼Œä½†æ˜¯aroundçš„ç›®æ ‡æ˜¯æ›¿ä»£åŸJPointï¼Œæ‰€ä»¥ä»–ä¸€èˆ¬ä¼šæœ‰è¿”å›å€¼ï¼Œè€Œä¸”è¿”å›å€¼çš„ç±»å‹éœ€è¦åŒ¹é…è¢«é€‰ä¸­çš„JPointï¼Œä¸¾ä¸ªæ —å­**

```java
public void testMethod(){
  byte[] test = null;
  test[1] = 0x33;
  return;
}
```

```java
import org.aspectj.lang.Signature;
import org.aspectj.lang.reflect.ConstructorSignature;

/**
 * Created by hefuduo on 2017/3/15.
 */
public aspect JPTest {
    public static void main(String args[]){
        
    }

    pointcut methodExecutionTest():execution(* *.TestDerived.testMethod());
    
    Object around():methodExecutionTest(){
        System.out.println("Around:" + thisJoinPoint);
        System.out.println("  at " + thisJoinPoint.getSourceLocation());
//        proceed();
        return null;
    }    
    
}

```



1. å°†æºä»£ç å‡½æ•°ä¸­çš„try-catchå¥å—å»æ‰ï¼Œé‚£ä¹ˆå‡½æ•°å°±ä¸€å®šä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
2. Aspectä»£ç ä¸­æ˜¯æˆ‘ä»¬é…ç½®çš„adviceï¼Œé™¤äº†beforeå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªaroundã€‚å®ƒçš„è¿”å›å€¼æ˜¯Objectã€‚è™½ç„¶åŒ¹é…çš„JPointæ˜¯testMethodï¼Œå…¶å®šä¹‰çš„è¿”å›å€¼æ˜¯voidï¼Œä½†æ˜¯AspectJè€ƒè™‘çš„å¾ˆå‘¨åˆ°ã€‚åœ¨aroundé‡Œï¼Œå¯ä»¥è®¾ç½®è¿”å›å€¼ç±»å‹ä¸ºObjectæ¥è¡¨ç¤ºè¿”å›ä»»æ„ç±»å‹çš„è¿”å›å€¼ã€‚Aspectåœ¨çœŸæ­£è¿”å›å‚æ•°çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œè½¬æ¢ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªè¿”å›intç±»å‹çš„å‡½æ•°ï¼Œåœ¨aroundé‡Œå¯ä»¥è¿”å›ä¸€ä¸ªIntegerï¼ŒAspectJä¼šè‡ªåŠ¨è½¬æ¢intä½œä¸ºè¿”å›å€¼ã€‚
3. å†çœ‹aroundä¸­çš„proceedï¼ˆï¼‰è¿™å¥è¯ã€‚è¿™ä»£è¡¨è°ƒç”¨çœŸæ­£çš„JPointå‡½æ•°ï¼Œå³testMethodã€‚ç”±äºè¿™é‡Œæˆ‘ä»¬å±è”½äº†proceedï¼Œæ‰€ä»¥testMethodçœŸæ­£çš„å†…å®¹å¹¶æœªæ‰§è¡Œï¼Œæ•…è¿è¡Œçš„æ—¶å€™ç©ºæŒ‡é’ˆå¼‚å¸¸å°±ä¸ä¼šæŠ›å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å®Œå…¨æˆªè·äº†testMethodçš„è¿è¡Œï¼Œç”šè‡³å¯ä»¥ä»»æ„ä¿®æ”¹å®ƒï¼Œè®©å®ƒçŸ¥è¡Œæ¯çš„å‡½æ•°éƒ½æ²¡æœ‰é—®é¢˜ã€‚

> aroundå¯ä»¥æ›¿ä»£before afterã€‚aroundä¸èƒ½ä¸afteråŒæ—¶å­˜åœ¨ã€‚





å‚æ•°ä¼ é€’å’ŒJPointä¿¡æ¯

ï¼ˆ1ï¼‰å‚æ•°ä¼ é€’ï¼ˆå¾…å®Œå–„ï¼‰

å‘adviceä¼ é€’å‚æ•°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨å‰é¢æåˆ°çš„this(),target(),args()ç­‰æ–¹æ³•ã€‚å¦å¤–ï¼Œæ•´ä¸ªpointcutså’Œadviceç¼–å†™çš„è¯­æ³•ä¹Ÿæœ‰ä¸€äº›åŒºåˆ«ã€‚

- l pointcutsä¿®æ”¹ï¼šåƒå®šä¹‰å‡½æ•°ä¸€æ ·å®šä¹‰pointcutsï¼Œç„¶ååœ¨this,targetæˆ–argsä¸­ç»‘å®šå‚æ•°åï¼ˆæ³¨æ„ï¼Œä¸å†æ˜¯å‚æ•°ç±»å‹ï¼Œè€Œæ˜¯å‚æ•°åï¼‰ã€‚
- l adviceä¿®æ”¹ï¼šä¹Ÿåƒå®šä¹‰å‡½æ•°ä¸€æ ·å®šä¹‰adviceï¼Œç„¶ååœ¨å†’å·åé¢çš„pointcutsä¸­ç»‘å®šå‚æ•°åï¼ˆæ³¨æ„æ˜¯å‚æ•°åï¼‰
- l åœ¨adviceçš„ä»£ç ä¸­ä½¿ç”¨å‚æ•°å



ï¼ˆ2ï¼‰JoinPointä¿¡æ¯æ”¶é›†

- l thisJoinpointå¯¹è±¡ï¼šåœ¨adviceä»£ç ä¸­å¯ç›´æ¥ä½¿ç”¨ã€‚ä»£è¡¨JPointæ¯æ¬¡è¢«è§¦å‘æ—¶çš„ä¸€äº›åŠ¨æ€ä¿¡æ¯ï¼Œæ¯”å¦‚å‚æ•°å•Šä¹‹ç±»çš„ã€
- l thisJoinpointStaticå¯¹è±¡ï¼šåœ¨adviceä»£ç ä¸­å¯ç›´æ¥ä½¿ç”¨ï¼Œä»£è¡¨JPointä¸­é‚£äº›ä¸å˜çš„ä¸œè¥¿ã€‚æ¯”å¦‚è¿™ä¸ªJPointçš„ç±»å‹ï¼ŒJPointæ‰€å¤„çš„ä»£ç ä½ç½®ç­‰ã€‚
- l thisEnclosingJoinPointStaticPartå¯¹è±¡ï¼šåœ¨adviceä»£ç ä¸­å¯ç›´æ¥ä½¿ç”¨ã€‚ä¹Ÿä»£è¡¨JPointä¸­ä¸å¯å˜çš„éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒåŒ…å«çš„ä¸œè¥¿å’ŒJPointçš„ç±»å‹æœ‰å…³ï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªcallç±»å‹JPointè€Œè¨€ï¼ŒthisEnclosingJoinPointStaticPartä»£è¡¨åŒ…å«è°ƒç”¨è¿™ä¸ªJPointçš„å‡½æ•°çš„ä¿¡æ¯ã€‚å¯¹ä¸€ä¸ªhandlerç±»å‹çš„JPointè€Œè¨€ï¼Œå®ƒä»£è¡¨åŒ…å«è¿™ä¸ªtry/catchçš„å‡½æ•°çš„ä¿¡æ¯ã€‚



### 5.1  AspectJç¼–è¯‘

- l AspectJæ¯”è¾ƒå¼ºå¤§ï¼Œé™¤äº†æ”¯æŒå¯¹sourceæ–‡ä»¶ï¼ˆå³ajæ–‡ä»¶ã€æˆ–@AspectJæ³¨è§£çš„Javaæ–‡ä»¶ï¼Œæˆ–æ™®é€šjavaæ–‡ä»¶ï¼‰ç›´æ¥è¿›è¡Œç¼–è¯‘å¤–ï¼Œ
- l è¿˜èƒ½å¯¹Javaå­—èŠ‚ç ï¼ˆå³å¯¹classæ–‡ä»¶ï¼‰è¿›è¡Œå¤„ç†ã€‚æœ‰æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å¯¹aspectj-testå°ä¾‹å­çš„classæ–‡ä»¶è¿›è¡Œåç¼–è¯‘ï¼Œä½ ä¼šå‘ç°AspectJæ— éæ˜¯åœ¨è¢«é€‰ä¸­çš„JPointçš„åœ°æ–¹åŠ ä¸€äº›hookå‡½æ•°ã€‚å½“ç„¶Beforeå°±æ˜¯åœ¨è°ƒç”¨JPointä¹‹å‰åŠ ï¼ŒAfterå°±æ˜¯åœ¨JPointè¿”å›ä¹‹å‰åŠ ã€‚
- l æ›´é«˜çº§çš„åšæ³•æ˜¯å½“classæ–‡ä»¶è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºåï¼Œç”±è™šæ‹Ÿæœºæ ¹æ®AOPçš„è§„åˆ™è¿›è¡Œhookã€‚

å¼•ç”¨æ–‡ç« ï¼š

[é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰çš„ç†è§£](http://blog.csdn.net/Intlgj/article/details/5671248)

[Aspect Oriented Programming in Android -Fernando Cejas](https://fernandocejas.com/2014/08/03/aspect-oriented-programming-in-android/)

[æ·±å…¥ç†è§£Androidä¹‹AOP](http://blog.csdn.net/innost/article/details/49387395)

å‚è€ƒæ–‡çŒ®

[1]  Manning.AspectJ.in.Actionç¬¬äºŒç‰ˆ

çœ‹ä¹¦è¿˜æ˜¯è¦æŒ‘ç®€å•æ˜“æ‡‚çš„ï¼ŒAOPæ¦‚å¿µå¹¶ä¸å¤æ‚ï¼Œè€ŒAspectJä¹Ÿæœ‰å¾ˆå¤šä¹¦ï¼Œä½†æ˜¯çœŸæ­£å†™å¾—é€šä¿—æ˜“æ‡‚çš„å°±æ˜¯è¿™æœ¬ï¼Œè™½ç„¶å®ƒæœ¬æ„æ˜¯ä»‹ç»Springä¸­çš„AOPï¼Œä½†å¯¹AspectJçš„è§£é‡ŠçœŸå¾—æ˜¯éå¸¸åˆ°ä½ï¼Œè€Œä¸”è¿˜æœ‰å¯¹@AspectJæ³¨è§£çš„ä»‹ç»ã€‚æœ¬æ–‡é™¤ç¬¬ä¸€ä¸ªå›¾å¤–ï¼Œå…¶ä»–å‚è€ƒç”¨å›¾å…¨æ˜¯æ¥è‡ªäºæ­¤ä¹¦ã€‚

[2]  http://fernandocejas.com/2014/08/03/aspect-oriented-programming-in-android/

Androidä¸­å¦‚ä½•ä½¿ç”¨AspectJï¼Œæœ€é‡è¦çš„æ˜¯å®ƒæ•™ä¼šæˆ‘ä»¬æ€ä¹ˆä½¿ç”¨aspectjç¼–è¯‘å·¥å…·APIã€‚