<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 2 | LeoHe&#39;s Space</title>
  <meta name="author" content="Leo He">
  
  <meta name="description" content="声明不息，学习不止">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="LeoHe&#39;s Space"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">LeoHe&#39;s Space</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>我的小站<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		Keep and carry on.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/09/26/2019-09-18-mvn生成aar的pom文件-2019/" title="mvn生成pom文件">使用mvn命令将jar/aar添加到本地仓库</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-09-26  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>背景:</p>
<p>​    某些情况下需要使用第三方的sdk, 但是第三方sdk大部分是将jar/aar文件离线提供的, 不方便公司内部各个APP 集成, 需要将aar上传到公司的maven仓库中, 可以使用mvn命令手动生成aar/jar文件的xml格式的pom文件.</p>
<p>使用如下</p>
<p>在${user}/.m2/repository目录下执行如下命令</p>
<pre class="line-numbers language-shell"><code class="language-shell">mvn install:install-file 
#parameters
-Dfile=<your aar/jar file path> 
-DgroupId=<groupId> # com.xxx.xxx
-DartifactId=<artifactId> #project id
-Dpackaging=<package format> # aar / jar 
-DgeneratePom=<false or true> #genegerate pom file or not
-Dversion=<x.y.z> #versioncode
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>活学活用, 现学现用, 后面记录.</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2019/09/26/2019-09-18-mvn生成aar的pom文件-2019/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/09/26/2019-09-26-Java集合分析1-2019/" title="集合框架API">Java集合分析1</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-09-26  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h1><p>先用一张图概览一下Java的集合框架</p>
<p><img src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1569498165722&di=89ac61c0e962f187f1660c5be5a76370&imgtype=0&src=http://aliyunzixunbucket.oss-cn-beijing.aliyuncs.com/png/20180201100829255445.png"></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2019/09/26/2019-09-26-Java集合分析1-2019/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/09/26/2019-09-26-Java集合分析2-2019/" title="表">Java集合分析2</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-09-26  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="表"><a href="#表" class="headerlink" title="表"></a>表</h1><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>ArrayList实现了List的接口, 是一个顺序存储的容器, 允许放入<code>null</code>元素,底层通过<em>数组实现</em>, 线程非安全.ArrayList有一个capacity表示容量, 如果在向容器中添加元素且容量不足的时候, 容器会自增大底层数组的大小.</p>
	
	</div>
  <a type="button" href="/2019/09/26/2019-09-26-Java集合分析2-2019/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/04/18/2019-03-20-UniversalImageLoader源码分析2-2019/" >Android-Universal-ImageLoader源代码分析2</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-04-18  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h2 id="包结构与架构"><a href="#包结构与架构" class="headerlink" title="包结构与架构"></a>包结构与架构</h2><p>包的结构与说明</p>
<pre><code>universalimageloader| 

    |-cache
        |-disc
        |-memory
    |-core
        |-assist
        |-decode
        |-display
        |-download
        |-imageaware
        |-listener
        |-process
    |-utils
</code></pre>
<h2 id="整体设计架构与说明"><a href="#整体设计架构与说明" class="headerlink" title="整体设计架构与说明"></a>整体设计架构与说明</h2><h3 id="结构图表示"><a href="#结构图表示" class="headerlink" title="结构图表示"></a>结构图表示</h3><p><img src="/img/uil/UIL.png" alt="UIL"></p>
<h3 id="各模块的说明"><a href="#各模块的说明" class="headerlink" title="各模块的说明"></a>各模块的说明</h3><p>整个库一级划分为<code>cache</code>, <code>core</code> , <code>util</code> 三个大模块.</p>
<ol>
<li><p><code>core</code>: 核心模块分为<code>decode(解码)</code>, <code>display(展示)</code>,<code>download(下载)</code>, <code>imageAware(显示图片的包装)</code>,<code>process(处理图片)</code> 五个重要的模块.此外,尤其要注意</p>
<p><code>ImageLoaderEngine</code>, <code>ImageDecorder</code>, <code>BitmapDisplayer</code>, <code>BitmapProcessor</code>,  <code>ImageDownloader</code>, <code>ImageAware</code> 这几个重要的类.</p>
</li>
<li><p><code>cache</code>: 缓存模块分为<code>disc</code>缓存和<code>memory</code>缓存两个模块</p>
</li>
<li><p><code>utils</code>:工具类模块, 如缓存工具类|Log|图像处理等. </p>
</li>
</ol>
<h2 id="加载图片流程"><a href="#加载图片流程" class="headerlink" title="加载图片流程"></a>加载图片流程</h2><h3 id="用一张图简单的标识图片加载流程"><a href="#用一张图简单的标识图片加载流程" class="headerlink" title="用一张图简单的标识图片加载流程"></a>用一张图简单的标识图片加载流程</h3><p><img src="https://raw.githubusercontent.com/nostra13/Android-Universal-Image-Loader/master/wiki/UIL_Flow.png"></p>
<h3 id="加载流程图"><a href="#加载流程图" class="headerlink" title="加载流程图"></a>加载流程图</h3><p><img src="/img/uil/UIL%E6%B5%81%E7%A8%8B%E5%9B%BE1.png" alt="UIL流程图1"></p>
<h3 id="详细执行流程"><a href="#详细执行流程" class="headerlink" title="详细执行流程"></a>详细执行流程</h3><h4 id="加载的时序图"><a href="#加载的时序图" class="headerlink" title="加载的时序图"></a>加载的时序图</h4><p><code>loadImage</code>本质也是调用<code>displayImage</code>因此直接看<code>displayImage</code>的执行流程即可.</p>
<p><code>ImageLoader.getInstance().displayImage(uri, imageview, options, listener);</code></p>
<p><img src="/img/uil/UIL%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="UIL时序图"></p>
<p>有缓存的时候, 先去检查缓存.参考流程图</p>
<h4 id="DisplayTask-的详细执行流程图"><a href="#DisplayTask-的详细执行流程图" class="headerlink" title="DisplayTask 的详细执行流程图"></a>DisplayTask 的详细执行流程图</h4><blockquote>
<p>参考<code>LoadAndDisplayimageTask</code>中的<code>run</code>方法</p>
</blockquote>
<p><img src="/img/uil/LoadAndDisplayImageTask.png" alt="LoadAndDisplayImageTask"></p>
<h3 id="TODO-UML"><a href="#TODO-UML" class="headerlink" title="//TODO UML"></a>//TODO UML</h3><h2 id="缓存算法详解"><a href="#缓存算法详解" class="headerlink" title="缓存算法详解"></a>缓存算法详解</h2><h3 id="包结构"><a href="#包结构" class="headerlink" title="包结构"></a>包结构</h3><p>缓存算法从缓存位置上划分为两种, <code>memory</code>和<code>disc</code>.</p>
<pre><code>|-cache
    |-disc
        |-impl(具体实现)
        |-naming(文件命名工具)
        |-DiskCache:interface(对外接口)
    |-memory
        |-impl(具体实现)
        |-BaseMemoryCache
        |-LimitedMemoryCache
        |-MemoryCache:interface(对外接口)
</code></pre>
<h3 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h3><h4 id="内存缓存"><a href="#内存缓存" class="headerlink" title="内存缓存"></a>内存缓存</h4><p><img src="/img/uil/memocache.png" alt="memocache"></p>
<h4 id="磁盘缓存"><a href="#磁盘缓存" class="headerlink" title="磁盘缓存"></a>磁盘缓存</h4><h2 id="解码器与下载器"><a href="#解码器与下载器" class="headerlink" title="解码器与下载器"></a>解码器与下载器</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//BaseImageDownloader</span>
<span class="token comment" spellcheck="true">//根据URI的类型, 获取不同的InputStream</span>
<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> InputStream <span class="token function">getStream</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> Object extra<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Scheme<span class="token punctuation">.</span><span class="token function">ofUri</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP<span class="token operator">:</span>
            <span class="token keyword">case</span> HTTPS<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromNetwork</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> FILE<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromFile</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> CONTENT<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromContent</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ASSETS<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromAssets</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DRAWABLE<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromDrawable</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UNKNOWN<span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getStreamFromOtherSource</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//BaseImageDecoders</span>
<span class="token comment" spellcheck="true">//将inputStream解码为Bitmap类型</span>

<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Bitmap <span class="token function">decode</span><span class="token punctuation">(</span>ImageDecodingInfo decodingInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Bitmap decodedBitmap<span class="token punctuation">;</span>
        ImageFileInfo imageInfo<span class="token punctuation">;</span>

        InputStream imageStream <span class="token operator">=</span> <span class="token function">getImageStream</span><span class="token punctuation">(</span>decodingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imageStream <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            L<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>ERROR_NO_IMAGE_STREAM<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">.</span><span class="token function">getImageKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            imageInfo <span class="token operator">=</span> <span class="token function">defineImageSizeAndRotation</span><span class="token punctuation">(</span>imageStream<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            imageStream <span class="token operator">=</span> <span class="token function">resetStream</span><span class="token punctuation">(</span>imageStream<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Options decodingOptions <span class="token operator">=</span> <span class="token function">prepareDecodingOptions</span><span class="token punctuation">(</span>imageInfo<span class="token punctuation">.</span>imageSize<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            decodedBitmap <span class="token operator">=</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>imageStream<span class="token punctuation">,</span> null<span class="token punctuation">,</span> decodingOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeSilently</span><span class="token punctuation">(</span>imageStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>decodedBitmap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            L<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>ERROR_CANT_DECODE_IMAGE<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">.</span><span class="token function">getImageKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            decodedBitmap <span class="token operator">=</span> <span class="token function">considerExactScaleAndOrientatiton</span><span class="token punctuation">(</span>decodedBitmap<span class="token punctuation">,</span> decodingInfo<span class="token punctuation">,</span> imageInfo<span class="token punctuation">.</span>exif<span class="token punctuation">.</span>rotation<span class="token punctuation">,</span>
                    imageInfo<span class="token punctuation">.</span>exif<span class="token punctuation">.</span>flipHorizontal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> decodedBitmap<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2019/04/18/2019-03-20-UniversalImageLoader源码分析2-2019/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/03/20/2019-03-20-UniversalImageLoader源码分析1-2019/" >Android-Universal-ImageLoader源代码分析1</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-03-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><h2 id="AUIL-的特点"><a href="#AUIL-的特点" class="headerlink" title="AUIL 的特点"></a>AUIL 的特点</h2><ul>
<li>多线程下载图片(同步异步)</li>
<li>提供多种ImageLoader的用户配置(thread executors, downloaders,decoder, memory and disk cache, display image options, etc.)</li>
<li>为每一个显示图片的调用提供了非常丰富的配置(stub image, caching switch, decoding options, Bitmap processing and displaying, etc)</li>
<li>提供图片的内存和文件缓存</li>
<li>图片加载的监听和下载进度的监听</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="QuickSetup"><a href="#QuickSetup" class="headerlink" title="QuickSetup"></a>QuickSetup</h3><ol>
<li><p>include library</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">implementation <span class="token string">'com.nostra13.universalimageloader:universal-image-loader:1.9.5'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>config manifest permission</p>
<pre class="line-numbers language-xml"><code class="language-xml">manifest>
    <span class="token comment" spellcheck="true">&lt;!-- Include following permission if you load images from Internet --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- Include following permission if you want to cache images on SD card --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.WRITE_EXTERNAL_STORAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>config imageloader and initial </p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Create global configuration and initialize ImageLoader with this config</span>
        ImageLoaderConfiguration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageLoaderConfiguration<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ImageLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Display Options</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// DON'T COPY THIS CODE TO YOUR PROJECT! This is just example of ALL options using.</span>
<span class="token comment" spellcheck="true">// See the sample project how to use ImageLoader correctly.</span>
DisplayImageOptions options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayImageOptions<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">showImageOnLoading</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_stub<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resource or drawable</span>
        <span class="token punctuation">.</span><span class="token function">showImageForEmptyUri</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_empty<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resource or drawable</span>
        <span class="token punctuation">.</span><span class="token function">showImageOnFail</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_error<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resource or drawable</span>
        <span class="token punctuation">.</span><span class="token function">resetViewBeforeLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">delayBeforeLoading</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">cacheInMemory</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">cacheOnDisk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">preProcessor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">postProcessor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">extraForDownloader</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">considerExifParams</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">imageScaleType</span><span class="token punctuation">(</span>ImageScaleType<span class="token punctuation">.</span>IN_SAMPLE_POWER_OF_2<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">bitmapConfig</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">decodingOptions</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">displayer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleBitmapDisplayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// default</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><h4 id="可接受的的URI资源示例"><a href="#可接受的的URI资源示例" class="headerlink" title="可接受的的URI资源示例"></a>可接受的的URI资源示例</h4><pre><code>&quot;http://site.com/image.png&quot; // from Web
&quot;file:///mnt/sdcard/image.png&quot; // from SD card
&quot;file:///mnt/sdcard/video.mp4&quot; // from SD card (video thumbnail)
&quot;content://media/external/images/media/13&quot; // from content provider
&quot;content://media/external/video/media/13&quot; // from content provider (video thumbnail)
&quot;assets://image.png&quot; // from assets
&quot;drawable://&quot; + R.drawable.img // from drawables (non-9patch images)
</code></pre>
<p><strong>NOTE:</strong> Use <code>drawable://</code> only if you really need it! Always <strong>consider the native way</strong> to load drawables - <code>ImageView.setImageResource(...)</code> instead of using of <code>ImageLoader</code>.</p>
<h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and display Bitmap in ImageView (or any other view </span>
<span class="token comment" spellcheck="true">//    which implements ImageAware interface)</span>
ImageLoader imageLoader <span class="token operator">=</span> ImageLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
imageLoader<span class="token punctuation">.</span><span class="token function">loadImage</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> imageview<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and return Bitmap to callback</span>
imageLoader<span class="token punctuation">.</span><span class="token function">loadImage</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleImageLoadingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingComplete</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> Bitmap loadedImage<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Do whatever you want with Bitmap</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and return Bitmap synchronously</span>
Bitmap bmp <span class="token operator">=</span> imageLoader<span class="token punctuation">.</span><span class="token function">loadImageSync</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="完全使用"><a href="#完全使用" class="headerlink" title="完全使用"></a>完全使用</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and display Bitmap in ImageView (or any other view </span>
<span class="token comment" spellcheck="true">//    which implements ImageAware interface)</span>
imageLoader<span class="token punctuation">.</span><span class="token function">displayImage</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> imageView<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ImageLoadingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingStarted</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingFailed</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> FailReason failReason<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingComplete</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> Bitmap loadedImage<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingCancelled</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ImageLoadingProgressListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgressUpdate</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> <span class="token keyword">int</span> current<span class="token punctuation">,</span> <span class="token keyword">int</span> total<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and return Bitmap to callback</span>
ImageSize targetSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageSize</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// result Bitmap will be fit to this size</span>
imageLoader<span class="token punctuation">.</span><span class="token function">loadImage</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> targetSize<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleImageLoadingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadingComplete</span><span class="token punctuation">(</span>String imageUri<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> Bitmap loadedImage<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Do whatever you want with Bitmap</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Load image, decode it to Bitmap and return Bitmap synchronously</span>
ImageSize targetSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageSize</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// result Bitmap will be fit to this size</span>
Bitmap bmp <span class="token operator">=</span> imageLoader<span class="token punctuation">.</span><span class="token function">loadImageSync</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> targetSize<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Load-amp-Display-Task-Flow"><a href="#Load-amp-Display-Task-Flow" class="headerlink" title="Load &amp; Display Task Flow"></a>Load &amp; Display Task Flow</h4><p>重要, 这个是AUIL的加载图片流程</p>
<p><img src="https://github.com/nostra13/Android-Universal-Image-Loader/raw/master/wiki/UIL_Flow.png" alt="AUIL"></p>
<h2 id="用户须知"><a href="#用户须知" class="headerlink" title="用户须知"></a>用户须知</h2><ol>
<li><p><strong>Caching is NOT enabled by default</strong>如果需要开启内存或者是磁盘缓存,需要配置<code>DisplayImageOptions</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Create default options which will be used for every </span>
<span class="token comment" spellcheck="true">//  displayImage(...) call if no options will be passed to this method</span>
DisplayImageOptions defaultOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayImageOptions<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">.</span><span class="token function">cacheInMemory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">cacheOnDisk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ImageLoaderConfiguration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageLoaderConfiguration<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">.</span><span class="token function">defaultDisplayImageOptions</span><span class="token punctuation">(</span>defaultOptions<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ImageLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Do it on Application start</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>// Then later, when you want to display image
ImageLoader.getInstance().displayImage(imageUrl, imageView); // Default options will be used
</code></pre>
<p>或者这样:</p>
<pre><code>DisplayImageOptions options = new DisplayImageOptions.Builder()
           ...
           .cacheInMemory(true)
           .cacheOnDisk(true)
           ...
           .build();
ImageLoader.getInstance().displayImage(imageUrl, imageView, options); // Incoming options will be used
</code></pre>
</li>
<li><p>注意<code>WRITE_EXTERNAL_STORAGE</code>这个权限的申请.</p>
</li>
<li><p>如果发生OOM可以尝试关掉内存缓存, 或减少线程池的大小, 或使用RGB-565的图像配置替换ARGB-8888, 或者裁剪图片显示小图.</p>
</li>
<li><p>MemoryChache的配置</p>
<ol>
<li>强引用 <code>LruMemoryCache</code></li>
<li>强弱引用混用 1,3除外的算法.</li>
<li>只是用弱引用 <code>WeakMemoryCache</code></li>
</ol>
</li>
<li><p><code>DiscChache</code>也是可配置的<code>UnlimitedDiscCache</code> 是最快的,但是占用存储空间</p>
</li>
<li><p>使用<code>RoundedBigmaDisplayer</code>或<code>FadeInbitmapDisplayer</code> 装饰图片加载</p>
</li>
<li><p>为了是<code>ListView</code> or <code>GrideView</code>的性能提升, 使用<code>PauseOnScrollListener</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">boolean</span> pauseOnScroll <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// or true</span>
<span class="token keyword">boolean</span> pauseOnFling <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// or false</span>
PauseOnScrollListener listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PauseOnScrollListener</span><span class="token punctuation">(</span>imageLoader<span class="token punctuation">,</span> pauseOnScroll<span class="token punctuation">,</span> pauseOnFling<span class="token punctuation">)</span><span class="token punctuation">;</span>
listView<span class="token punctuation">.</span><span class="token function">setOnScrollListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>If you see in logs some strange supplement at the end of image URL (e.g. <a target="_blank" rel="noopener" href="http://anysite.com/images/image.png_230x460">http://anysite.com/images/image.png_230x460</a>) then it doesn’t mean this URL is used in requests. This is just “URL + target size”, also this is key for Bitmap in memory cache. This postfix (_230x460) is NOT used in requests.</p>
</li>
</ol>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2019/03/20/2019-03-20-UniversalImageLoader源码分析1-2019/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/27/2017-12-28-AndroidJNI-2017/" >Android JNI 系列</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-27  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="Android-JNI-基本知识"><a href="#Android-JNI-基本知识" class="headerlink" title="Android JNI 基本知识"></a>Android JNI 基本知识</h1><h2 id="1-1-什么是JNI"><a href="#1-1-什么是JNI" class="headerlink" title="1.1 什么是JNI"></a>1.1 什么是JNI</h2><p><code>JNI (Java Native Interface)</code>,它提供了若干<code>API</code>使得<code>Java</code>可以和其他语言互通,是<code>JDK</code>的一部分.</p>
<p>理解这些就可以了!</p>
<h2 id="1-2-为什么使用JNI"><a href="#1-2-为什么使用JNI" class="headerlink" title="1.2 为什么使用JNI"></a>1.2 为什么使用JNI</h2><p>使用<code>JNI</code>是为了将现有的<code>C或C++</code>库集成到使用<code>Java</code>语言开发的应用中,或者有些性能要求较高的场景下,使用<code>C</code>或<code>C++</code>才能满足的场景.</p>
<h2 id="1-3-使用JNI带来的问题"><a href="#1-3-使用JNI带来的问题" class="headerlink" title="1.3 使用JNI带来的问题"></a>1.3 使用JNI带来的问题</h2><p>程序不再跨平台,还有JNI带来的内存问题,以及可能引起的<code>Crash</code></p>
<h1 id="使用Android-Studio-搭建JNI开发环境"><a href="#使用Android-Studio-搭建JNI开发环境" class="headerlink" title="使用Android Studio 搭建JNI开发环境"></a>使用Android Studio 搭建JNI开发环境</h1><p>目前使用<code>Android Studio 3.0</code>可以直接建立一个支持<code>C或C++</code>语言的<code>JNI</code>项目.</p>
<p>如果需要将现有的应用集成<code>JNI</code>可参照<code>Google Dev</code>的官方文档操作.</p>
<p>编译<code>JNI</code>程序,可以使用<code>NDK</code>编译,或者使用<code>CMAKE</code>来编译,现在来讲都可行,推荐使用<code>CMAKE</code>来编译.</p>
<p>在<code>app</code>目录下建立一个<code>JNI目录</code>源文件都放到这里.</p>
<p><img src="/img/jni/jni1.png" alt="error"></p>
<p><img src="/img/jni/jni2.png" alt="jni2"></p>
<p>注意目录名称是<code>JNI</code>,只是在<code>Android Studio</code>中显示为<code>cpp目录</code></p>
<p>下面写CMAKE文件</p>
<pre class="line-numbers language-cmake"><code class="language-cmake"># 这里使用的是bsdiff patch的JNI库例子.
# For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html

# Sets the minimum version of CMake required to build the native library.
# 设置CMake编译器的版本
cmake_minimum_required(VERSION 3.4.1)

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.
# 声明源文件路径
file(GLOB bzip "src/main/jni/bzip2/*.c")
file(GLOB bs_src "src/main/jni/*.c")
# 引入头文件路径 (这里必须要引入)
include_directories(
"src/main/jni/bzip2/"
)
# 引入源文件
add_library( # Sets the name of the library.
             # 设置编译后的库名称
             native-lib

             # Sets the library as a shared library.
             SHARED

             # Provides a relative path to your source file(s).
             # 设置源文件的位置
             $&#123;bzip&#125;
             src/main/jni/native-lib.c )

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # Sets the name of the path variable.
              log-lib

              # Specifies the name of the NDK library that
              # you want CMake to locate.
              # 引入依赖库
              log )

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
                       native-lib
                        
                       # Links the target library to the log library
                       # included in the NDK.
                       $&#123;log-lib&#125; )
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单的来一个JNI HelloWorld</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"native-lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> String <span class="token function">helloworld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
JNIEXPORT jstring JNICALL
<span class="token function">Java_com_sankuai_meituan_testjni_MainActivity_helloworld</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从<code>C</code>的函数定义中可以发现,函数的签名是有一定规律的一般是下面这种格式</p>
<p><code>Java_[包名]_[类名]_[方法名](JNIEnv * env,jclass type,[params])</code></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2017/12/27/2017-12-28-AndroidJNI-2017/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/13/2017-12-13-androidIPC-2017/" >Android IPC 机制</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="Andorid-IPC"><a href="#Andorid-IPC" class="headerlink" title="Andorid IPC"></a>Andorid IPC</h1><h2 id="Android中的多进程模式"><a href="#Android中的多进程模式" class="headerlink" title="Android中的多进程模式"></a>Android中的多进程模式</h2><h3 id="1-开启多进程模式"><a href="#1-开启多进程模式" class="headerlink" title="1. 开启多进程模式"></a>1. 开启多进程模式</h3><p>在Android中,开启多进程的方式是给四大组件(静态注册),加上process属性,让其运行在其他进程,默认的进程的名称为包名.</p>
<p>例如:</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> 
          <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span>
          <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:remote<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
          <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.SecondActivity<span class="token punctuation">"</span></span>
          <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[包名].remote<span class="token punctuation">"</span></span>
          <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个<code>MainActivity</code>将运行在包名<code>+:remote</code>这个名称的进程中.而<code>SecondActivity</code>将运行在<code>[packageName].remote</code>这个进程中.</p>
<p>二者区别:</p>
<p>加冒号<code>&#39;:&#39;</code>这种方式是在当前进程名称前面附加上当前应用的包名,是一种简写方式;对于<code>SecondActivity</code>来说是完整的进程命名.此外,加冒号这种方式运行的进程是当前应用的私有进程,其他应用的组件不可以和它运行在同一个进程中,而采用完整命名的进行是全局进程,其他应用通过<code>ShareUID</code>方式可以和它运行在同一个进程中.</p>
<p><strong>Android系统会给每个应用分配一个唯一的UID,具有相同UID的应用才能共享数据,两个应用听过<code>ShareUID</code>运行在同一个进程是有要求的,这两个应用必须有相同的<code>ShareUID</code>并且包签名相同才可以.</strong></p>
<h3 id="2-多进程模式的运行机制"><a href="#2-多进程模式的运行机制" class="headerlink" title="2. 多进程模式的运行机制"></a>2. 多进程模式的运行机制</h3><p>多进程所带来的问题</p>
<ul>
<li>静态成员和单例完全失效</li>
<li>线程同步机制完全失效</li>
<li>SharePreference的可靠性下降(SP只是做了线程同步喂)</li>
<li>Application多次创建</li>
</ul>
<h2 id="IPC-基础概念"><a href="#IPC-基础概念" class="headerlink" title="IPC 基础概念"></a>IPC 基础概念</h2><h3 id="1-Serializable"><a href="#1-Serializable" class="headerlink" title="1. Serializable"></a>1. Serializable</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span>6081784905993904744L<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
  
    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span><span class="token keyword">int</span> age<span class="token punctuation">,</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getSerialVersionUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serialVersionUID<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>序列化与反序列化<code>User</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//序列化</span>
User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"duo"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ObjectOutputStream oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//反序列化</span>
 ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 User user2 <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-Parcelable"><a href="#2-Parcelable" class="headerlink" title="2. Parcelable"></a>2. Parcelable</h3><p><code>parcelable</code>是Android提供的一种序列化和反序列化方式,它比<code>Serializable</code>效率更高一些.</p>
<pre class="line-numbers language-java"><code class="language-java">

<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Parcel<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Parcelable<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by hefuduo on 2017/12/13.
 */</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">public</span> String name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token function">User</span><span class="token punctuation">(</span>Parcel in<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        name <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Creator<span class="token operator">&lt;</span>User<span class="token operator">></span> CREATOR <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Creator</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> User <span class="token function">createFromParcel</span><span class="token punctuation">(</span>Parcel in<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">newArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">describeContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeToParcel</span><span class="token punctuation">(</span>Parcel dest<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        dest<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dest<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dest<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-Binder"><a href="#3-Binder" class="headerlink" title="3. Binder"></a>3. Binder</h3>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2017/12/13/2017-12-13-androidIPC-2017/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/28/2017-08-28-Groovy DSL-2017/" >Groovy DSL</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-28  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2017/08/28/2017-08-28-Groovy DSL-2017/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/28/2017-08-28-Groovy与元编程-2017/" >Groovy:MOP与元编程</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-28  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="Groovy-MOP与元编程"><a href="#Groovy-MOP与元编程" class="headerlink" title="Groovy :MOP与元编程"></a>Groovy :MOP与元编程</h1><blockquote>
<p>在Java中,使用反射可以在运行时探索程序的结构,以及程序的类,累的方法,方法接受的参数.然而,我们仍然局限于所创建的静态结构.我们无法在运行时修改一个对象的类型,或是让它动态获取行为–至少现在还不能.如果可以基于应用的当前状态,或者是基于应用所接受的输入,动态地添加方法和行为,代码就会变得更加灵活,我们创造力和开发效率也会提高.那么Groovy就是提供了这一功能</p>
</blockquote>
<p>*元编程(metaprogramming)*意味着编写能够操作程序的程序,包括操作程序自身.像Groovy这样的动态语言通过元对象协议(MetaObject Protocal, MOP)提供了这种能力.利用Groovy的MOP,创建类,编写单元测试和引入模拟对象都是很容易的.</p>
<p>在Groovy中,使用MOP可以动态的调用方法,甚至可以在运行时合成类和方法.该特性让我们有这种感觉:对象顺利地修改了它的类.</p>
<p>讨论两个方面:Groovy对象的组成和Groovy如何解析Java对象和Grooy对象的方法调用.</p>
<h2 id="探索元对象"><a href="#探索元对象" class="headerlink" title="探索元对象"></a>探索元对象</h2><h3 id="Groovy-对象"><a href="#Groovy-对象" class="headerlink" title="Groovy 对象"></a>Groovy 对象</h3><p>Groovy对象是带有附加功能的Java对象.在Groovy中,Groovy对象比编译好的Java对象具有更多的动态行为.</p>
<p>在一个Groovy应用中,我们会使用三类对象:POJO,POGO和Groovy拦截器.</p>
<h3 id="查询方法和属性"><a href="#查询方法和属性" class="headerlink" title="查询方法和属性"></a>查询方法和属性</h3><p>调用一个方法</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">str <span class="token operator">=</span> <span class="token string">"hello"</span>
methodName <span class="token operator">=</span> <span class="token string">'toUpperCase'</span>

methodOfInterest <span class="token operator">=</span> str<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">getMetaMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span>
println methodOfInterest<span class="token operator">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用<code>respondsTo</code>方法判断是否存在方法</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">str <span class="token operator">=</span> <span class="token string">"hello"</span>
println String<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">respondsTo</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'toUpperCase'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'yes'</span> <span class="token punctuation">:</span> <span class="token string">'no'</span>  <span class="token comment" spellcheck="true">//yes</span>
println String<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">respondsTo</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'compareTo'</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'yes'</span> <span class="token punctuation">:</span> <span class="token string">'no'</span> <span class="token comment" spellcheck="true">//yes</span>
println String<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">respondsTo</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'toUpperCase'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'yes'</span> <span class="token punctuation">:</span> <span class="token string">'no'</span> <span class="token comment" spellcheck="true">//no</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="动态的访问对象"><a href="#动态的访问对象" class="headerlink" title="动态的访问对象"></a>动态的访问对象</h3><p>除了前面介绍的方法和属性的查询方式和动态调用方式,Groovy还有其他比较方便的访问属性和调用方法的方式.一下为例子.</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">printInfo</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    usrRequestedProperty <span class="token operator">=</span> <span class="token string">'bytes'</span>
    usrRequestMethod <span class="token operator">=</span> <span class="token string">'toUpperCase'</span>
    
    println obj<span class="token punctuation">[</span>usrRequestedProperty<span class="token punctuation">]</span>
    println obj<span class="token operator">.</span><span class="token string">"$usrRequestedProperty"</span>
    
    println obj<span class="token operator">.</span><span class="token string">"$usrRequestMethod"</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    println obj<span class="token operator">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>usrRequestMethod<span class="token punctuation">,</span>null<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

printInfo <span class="token string">'hello'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-console"><code class="language-console">[104, 101, 108, 108, 111]
[104, 101, 108, 108, 111]
HELLO
HELLO
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>要迭代一个对象的所有属性,我们可以使用properties属性(或者getter)</p>
<p>如下:</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token string">'hello'</span><span class="token operator">.</span>properties<span class="token operator">.</span>each <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println it
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="使用MOP拦截方法"><a href="#使用MOP拦截方法" class="headerlink" title="使用MOP拦截方法"></a>使用MOP拦截方法</h2><blockquote>
<p>在Groovy中可以非常方便的实现AOP编程,比如方法拦截或者方法建议.<code>before advice | after advice | around advice</code>.</p>
</blockquote>
<h3 id="使用GroovyInterceptable拦截方法"><a href="#使用GroovyInterceptable拦截方法" class="headerlink" title="使用GroovyInterceptable拦截方法"></a>使用GroovyInterceptable拦截方法</h3><p>如果一个Groovy对象实现了<code>GroovyInterceptable</code>接口,那么当调用改对象上的任何一个方法时,不管是存在的还是不存在的,被调用的都将是<code>invokeMethod()</code>.也就是说,<code>GroovyInterceptable的invokeMethod方法劫持了该对象上的所有方法调用</code></p>
<p>如果想要实现<em>环绕建议</em>,只需要在这个方法内实现我们的逻辑.然而想实现<em>前置逻辑或后置建议或者both</em>,我们首先要实现自己的前置/后置逻辑,然后在恰当的时机路由到真实的方法,要路由调用,我们将使用<code>MetaMethod</code>,它可以从<code>MetaClass</code>获得</p>
<p>ps:</p>
<p>对于其他Groovy对象(没有实现上述接口的,只有调用到不存在的方法的时候才会调用该方法.有个例外,如果我们在一个对象的MetaClass上实现了<code>invokeMethod</code>不管方法存在与否,都会调用到该方法.</p>
<p>例子:</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token keyword">implements</span> <span class="token class-name">GroovyInterceptable</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"check called ..."</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start called ..."</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">def</span> <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span>println <span class="token string">"drive called"</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">def</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span>println <span class="token string">"Called to $name intercepted"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token string">'check'</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'running filter'</span><span class="token punctuation">)</span>
            Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">getMetaMethod</span><span class="token punctuation">(</span><span class="token string">'check'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">def</span> validMethod <span class="token operator">=</span> Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">getMetaMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>validMethod <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            validMethod<span class="token operator">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
car<span class="token operator">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
car<span class="token operator">.</span><span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
car<span class="token operator">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    car<span class="token operator">.</span><span class="token function">speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println e
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-console"><code class="language-console">Called to start intercepted
running filtercheck called ...
start called ...
Called to drive intercepted
running filtercheck called ...
drive called
Called to check intercepted
check called ...
Called to speed intercepted
running filtercheck called ...
groovy.lang.MissingMethodException: No signature of method: Car.speed() is applicable for argument types: () values: []
Possible solutions: sleep(long), sleep(long, groovy.lang.Closure), split(groovy.lang.Closure), check(), start(), inspect()
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用MetaClass拦截方法"><a href="#使用MetaClass拦截方法" class="headerlink" title="使用MetaClass拦截方法"></a>使用MetaClass拦截方法</h3><blockquote>
<p>使用GroovyInterceptable拦截了方法的调用,这种方式适合拦截作者是我们自己的类中的方法.然而,如果我们无权修改类的源代码,或者这个类是个Java类,就行不通了,此外,我们也可能在运行时决定基于某些条件或应用状态开始拦截调用,对于这几种情况,我们可以在MetaClass上实现<code>invokeMethod()</code>方法,并以此来拦截方法.</p>
</blockquote>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">Car</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"check called ..."</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start called ..."</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    <span class="token keyword">def</span> <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token operator">.</span>out<span class="token operator">.</span>println <span class="token string">"drive called"</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

Car<span class="token operator">.</span>metaClass<span class="token operator">.</span>invokeMethod <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    String name<span class="token punctuation">,</span> args <span class="token operator">-></span>
        System<span class="token operator">.</span>out<span class="token operator">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Call to $name intercepted ... "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token string">'check'</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token operator">.</span>out<span class="token operator">.</span>print<span class="token string">"Running filter"</span>
            Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">getMetaMethod</span><span class="token punctuation">(</span><span class="token string">'check'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span>null<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        
        <span class="token keyword">def</span> validMethod <span class="token operator">=</span> Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">getMetaMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>validMethod <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            validMethod<span class="token operator">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Car<span class="token operator">.</span>metaClass<span class="token operator">.</span><span class="token function">invokeMissingMethod</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span>name<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

car<span class="token operator">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
car<span class="token operator">.</span><span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
car<span class="token operator">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    car<span class="token operator">.</span><span class="token function">speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println e
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2017/08/28/2017-08-28-Groovy与元编程-2017/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/22/2017-08-22-groovy闭包-2017/" >Groovy之闭包</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-22  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>[TOC]</p>
<h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><p>闭包是一种可执行的代码块的方法，闭包也是对象，可以想方法一样传递参数。由于闭包是代码块，因此也可以在需要时执行。定义闭包的时候可以使用一个或者多个参数。闭包可以访问属性信息，意味着可以访问并修其作用于内的所有变量值。</p>
<h2 id="闭包-1"><a href="#闭包-1" class="headerlink" title="闭包"></a>闭包</h2><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> greeting <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token keyword">def</span> clos <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    param <span class="token operator">-></span>
        println <span class="token string">"$greeting $param"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

clos<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span>

greeting <span class="token operator">=</span> <span class="token string">'welcome'</span>
clos<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> greeting <span class="token operator">=</span> <span class="token string">'Bonjour'</span><span class="token comment" spellcheck="true">//this will not affect closure</span>
    clos<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ken'</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token function">demo</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//output welcome ken</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上代码说明，只有闭包被定义且存在，而不是在被调用时，可以访问其状态值。</p>
<p> 闭包也常用在集合中。使用闭包可以更高效的遍历元素。</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token number">1</span><span class="token operator">.</span><span class="token function">upto</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println it 
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//或者你也可以这么写</span>
<span class="token number">1</span><span class="token operator">.</span><span class="token function">upto</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println it
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//阶乘</span>
<span class="token keyword">def</span> fac <span class="token operator">=</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token operator">.</span><span class="token function">upto</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    num <span class="token operator">-></span>
        fac <span class="token operator">*=</span> num
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println <span class="token string">"Factorical : $fac"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="闭包与集合和字符串"><a href="#闭包与集合和字符串" class="headerlink" title="闭包与集合和字符串"></a>闭包与集合和字符串</h2><p>常用each方法来遍历。</p>
<p><code>find()返回第一个满足条件的元素，findAll()返回所有满足条件的元素</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>
list<span class="token operator">.</span>findAll <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    it <span class="token operator">></span> <span class="token number">5</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">.</span>each <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    println it
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>any() and every()</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> anyEle <span class="token operator">=</span> list<span class="token operator">.</span>any <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    it <span class="token operator">></span> <span class="token number">5</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
println anyEle <span class="token comment" spellcheck="true">//true</span>

<span class="token keyword">def</span> everyEle <span class="token operator">=</span> list<span class="token operator">.</span>every <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    it <span class="token operator">></span> <span class="token number">5</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println everyEle  <span class="token comment" spellcheck="true">//false</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>collect() and inject</code></p>
<p>collect用来遍历集合并且返回一个集合</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">
<span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true">//collect 返回一个由closure转换后的集合</span>
<span class="token keyword">def</span> newlist <span class="token operator">=</span> list<span class="token operator">.</span>collect <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    it <span class="token operator">*</span> it
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println newlist

<span class="token comment" spellcheck="true">//collect 的高级范例</span>
<span class="token keyword">def</span> doubles <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    item <span class="token operator">-></span>
        <span class="token number">2</span> <span class="token operator">*</span> item
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> triples <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    item <span class="token operator">-></span>
        <span class="token number">3</span> <span class="token operator">*</span> item
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> isEven <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    item <span class="token operator">-></span> 
        item<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>clos<span class="token punctuation">,</span>list<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token operator">.</span><span class="token function">collect</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>inject用来遍历集合，首先将需要传递的值和集合项目传递给必报，此时其传递的值将作为处理结果，然后再和下一个集合项目一起传递给闭包，以此类推</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> factorial <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
        <span class="token operator">.</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    previous<span class="token punctuation">,</span> element <span class="token operator">-></span>
        previous <span class="token operator">*</span> element
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println factorial
<span class="token comment" spellcheck="true">//=====</span>
<span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
factorial <span class="token operator">=</span> list<span class="token operator">.</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    prviouse<span class="token punctuation">,</span> element <span class="token operator">-></span>
        prviouse <span class="token operator">*</span> element
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
println factorial
<span class="token comment" spellcheck="true">//=====</span>
<span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> closure <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    previous<span class="token punctuation">,</span> element <span class="token operator">-></span>
        previous <span class="token operator">*</span> element
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> factorial <span class="token operator">=</span> list<span class="token operator">.</span><span class="token function">inject</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>closure<span class="token punctuation">)</span>
println factorial
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="闭包的其他特性"><a href="#闭包的其他特性" class="headerlink" title="闭包的其他特性"></a>闭包的其他特性</h2><p>由于闭包也是一个对象，因此它可以作为方法的参数，同时也可以作为另一个闭包的参数。</p>
<h3 id="作为方法的参数"><a href="#作为方法的参数" class="headerlink" title="作为方法的参数"></a>作为方法的参数</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> predict<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token operator">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>predict<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> isEven <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> isOdd <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isEven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> evens <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span>isEven<span class="token punctuation">)</span>
println evens

<span class="token keyword">def</span> odds <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span>isOdd<span class="token punctuation">)</span>
println odds
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="作为另一个闭包的参数"><a href="#作为另一个闭包的参数" class="headerlink" title="作为另一个闭包的参数"></a>作为另一个闭包的参数</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> takewhile <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    predicate<span class="token punctuation">,</span> list <span class="token operator">-></span>
        <span class="token keyword">def</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>element <span class="token keyword">in</span> list<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                result <span class="token operator">&lt;&lt;</span> element
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> isEven <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> isOdd <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isEven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> table1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> table2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> evens <span class="token operator">=</span> takewhile<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span>isEven<span class="token punctuation">,</span>table1<span class="token punctuation">)</span>
println evens
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="作为返回值"><a href="#作为返回值" class="headerlink" title="作为返回值"></a>作为返回值</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">multiply</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        y<span class="token operator">-></span>
            <span class="token keyword">return</span> x <span class="token operator">*</span> y
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> twice <span class="token operator">=</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

println <span class="token function">twice</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="嵌套闭包"><a href="#嵌套闭包" class="headerlink" title="嵌套闭包"></a>嵌套闭包</h3><h4 id="选择排序算法的实现"><a href="#选择排序算法的实现" class="headerlink" title="选择排序算法的实现"></a>选择排序算法的实现</h4><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> selection <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    list <span class="token operator">-></span>
  <span class="token comment" spellcheck="true">//交换两个位置的数</span>
        <span class="token keyword">def</span> swap <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            sList<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q <span class="token operator">-></span>
                <span class="token keyword">def</span> temp <span class="token operator">=</span> sList<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
                sList<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> sList<span class="token punctuation">[</span>q<span class="token punctuation">]</span>
                sList<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">=</span> temp
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//找出最小数位置</span>
        <span class="token keyword">def</span> minimumPosition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            pList<span class="token punctuation">,</span> from <span class="token operator">-></span>
                <span class="token keyword">def</span> mPos <span class="token operator">=</span> from
                <span class="token keyword">def</span> nextFrom <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> from
                <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token keyword">in</span> nextFrom<span class="token operator">..&lt;</span>pList<span class="token operator">.</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pList<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pList<span class="token punctuation">[</span>mPos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        mPos <span class="token operator">=</span> j
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> mPos
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">def</span> size <span class="token operator">=</span> list<span class="token operator">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token number">0</span><span class="token operator">..&lt;</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">def</span> minPos <span class="token operator">=</span> <span class="token function">minimumPosition</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
            <span class="token function">swap</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> minPos<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> sorted <span class="token operator">=</span> <span class="token function">selection</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span>
println sorted
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="关于闭包的更多信息"><a href="#关于闭包的更多信息" class="headerlink" title="关于闭包的更多信息"></a>关于闭包的更多信息</h1><h2 id="闭包和不确定性"><a href="#闭包和不确定性" class="headerlink" title="闭包和不确定性"></a>闭包和不确定性</h2><p>先看一个例子，闭包在实参列表外部。如果方法的最后一个参数是闭包，那么可以将它从实参列表中删除，并放在气候的括号后面。</p>
<p><code>demo(closure) 变为 demo closure</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> greeting <span class="token operator">=</span> <span class="token string">'Hello'</span>
<span class="token keyword">def</span> clo <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    param <span class="token operator">-></span>
        println <span class="token string">"$greeting $param"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> greeting <span class="token operator">=</span> <span class="token string">'Bonjour'</span>
    clos<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'Ken'</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//demo()clo error null point exception,解释见后。</span>
 
demo clo

<span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    param <span class="token operator">-></span>
        println <span class="token string">"welcome $param"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设<code>clos</code>是一个闭包变量，<code>&#123;...&#125;</code>是一个闭包体。假设<code>x</code>和<code>y</code>是两个随意设置的值，则查看如下不同的方法调用语句：</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token function">method</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">...</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">method</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">...</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">method</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>clos<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">method</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>clos <span class="token comment" spellcheck="true">//error no such method</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二行代码把闭包体直接放在调用参数的后面。第四行代码说明，同样的做法也许不适用闭包变量。Groovy解释器无法忍冬clos标识符是该方法的调用的一部分，因此Groovy解释器就会报错，说明找不到只有具有两个参数的method方法。</p>
<p>如果method标识具有一个参数的方法：</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">method</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token punctuation">...</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>则clos是个闭包变量，{…}是闭包体，如下调用语句</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token function">method</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">...</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">...</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//ok</span>
method<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">...</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//ok    </span>
<span class="token function">method</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span>clos   <span class="token comment" spellcheck="true">//error null point exception </span>
method clos    <span class="token comment" spellcheck="true">//ok</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第五行代码中，调用方法时不适用任何实参，在该方法体中，形参将被初始化为null，在这个方法中使用闭包变量将会导致系统错误。</p>
<h2 id="闭包和方法"><a href="#闭包和方法" class="headerlink" title="闭包和方法"></a>闭包和方法</h2><p>对于如下两个结构</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> mDouble <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    n <span class="token operator">-></span>
          <span class="token keyword">return</span> <span class="token number">2</span><span class="token operator">*</span>n
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">mDouble</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token operator">*</span>n
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前者是一个闭包定义，后者是一个方法定义。注意，任何闭包引用肯定有固定的作用域。不能出现同名的闭包变量，但是可以出现同名方法（方法重载）</p>
<h2 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h2><p>像方法一样，闭包也可以被分配带默认值的参数。</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> greeting <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"leo"</span> <span class="token operator">-></span>
        println <span class="token string">"$msg $name"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token function">greeting</span><span class="token punctuation">(</span><span class="token string">"hello "</span><span class="token punctuation">)</span>
<span class="token function">greeting</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"julia"</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="闭包和作用域"><a href="#闭包和作用域" class="headerlink" title="闭包和作用域"></a>闭包和作用域</h2><p>上面讲到的局部闭包实现的选择性排序算法。下面讲一个使用冒泡算法排序。</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> bubbleSort <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    list <span class="token operator">-></span>
        <span class="token keyword">def</span> swap <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            sList<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q <span class="token operator">-></span>
                <span class="token keyword">def</span> temp
                temp <span class="token operator">=</span> sList<span class="token punctuation">[</span>q<span class="token punctuation">]</span>
                sList<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">=</span> sList<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
                sList<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> temp
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">def</span> size <span class="token operator">=</span> list<span class="token operator">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">def</span> sortedPosition <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>sortedPosition <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..&lt;</span><span class="token punctuation">(</span>size <span class="token operator">-</span> sortedPosition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;</span> list<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token function">swap</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> index<span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            sortedPosition <span class="token operator">++</span> 
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">78</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">]</span>
<span class="token function">bubbleSort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
println list
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，闭包只能由语句组成，这意味着闭包中不能有方法定义，因此局部闭包swap不能使用方法定义来替代。</p>
<h2 id="递归闭包"><a href="#递归闭包" class="headerlink" title="递归闭包"></a>递归闭包</h2><p>用递归的方法求<code>n!</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> factorial <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    n <span class="token operator">-></span>
        <span class="token keyword">return</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> n <span class="token operator">*</span> <span class="token function">call</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="状态类型"><a href="#状态类型" class="headerlink" title="状态类型"></a>状态类型</h2><p>可以使用参数和返回值的动态类型来定义闭包。这个特性使得闭包更加通用。</p>
<h3 id="闭包的动态类型"><a href="#闭包的动态类型" class="headerlink" title="闭包的动态类型"></a>闭包的动态类型</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> times <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> times <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println <span class="token function">times</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
println <span class="token function">times</span><span class="token punctuation">(</span><span class="token number">3.2</span><span class="token punctuation">,</span><span class="token number">4.15</span><span class="token punctuation">)</span>
println <span class="token function">times</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在调用时，才确定x和y的类型</p>
<pre class="line-numbers language-console"><code class="language-console">12
13.280
hellohellohellohello
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="静态指定参数类型的闭包"><a href="#静态指定参数类型的闭包" class="headerlink" title="静态指定参数类型的闭包"></a>静态指定参数类型的闭包</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> times <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    Number x<span class="token punctuation">,</span> Number y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种方式就限定了闭包的参数类型，不能是Number及其子类意外的其他类型。</p>
<h2 id="有关实参的约定"><a href="#有关实参的约定" class="headerlink" title="有关实参的约定"></a>有关实参的约定</h2><p>在调用闭包时，实参的数量必须严格匹配闭包定义时的形参数量。否则，Groovy解释器就会报错，指示参数不正确。</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> clos <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c <span class="token operator">-></span>
   <span class="token string">"clos($a$b$c)"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token function">clos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//ok</span>
<span class="token function">clos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//error</span>
<span class="token function">clos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//error</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="闭包、集合、范围"><a href="#闭包、集合、范围" class="headerlink" title="闭包、集合、范围"></a>闭包、集合、范围</h2><p>列表、映射、和范围等类型提供很多实用闭包作为参数的方法，这有利于迭代处理集合或者范围中的每个元素，并执行指定的任务。</p>
<p>迭代器方法</p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>any*</td>
<td></td>
</tr>
<tr>
<td>collect*</td>
<td></td>
</tr>
<tr>
<td>collect*</td>
<td></td>
</tr>
<tr>
<td>each*</td>
<td></td>
</tr>
<tr>
<td>every*</td>
<td></td>
</tr>
<tr>
<td>find*</td>
<td></td>
</tr>
<tr>
<td>findAll*</td>
<td></td>
</tr>
<tr>
<td>findIndexOf*</td>
<td></td>
</tr>
<tr>
<td>inject*</td>
<td></td>
</tr>
<tr>
<td>reverseEach*</td>
<td></td>
</tr>
<tr>
<td>sort*</td>
<td></td>
</tr>
</tbody></table>
<h2 id="Return-语句"><a href="#Return-语句" class="headerlink" title="Return 语句"></a>Return 语句</h2><p>我们先看一个代码范例：</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">isMemberA</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> size <span class="token operator">=</span> list<span class="token operator">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token keyword">in</span> <span class="token number">0</span><span class="token operator">..&lt;</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> item<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">isMemberB</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    list<span class="token operator">.</span>each <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> item<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>

println <span class="token function">isMemberA</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>numbers<span class="token punctuation">)</span>
println <span class="token function">isMemberA</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span>numbers<span class="token punctuation">)</span>

println <span class="token function">isMemberB</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>numbers<span class="token punctuation">)</span>
println <span class="token function">isMemberB</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span>numbers<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//这个有问题</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出为：</p>
<pre class="line-numbers language-console"><code class="language-console">false
true
false
false
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>显然，Groovy方式的返回是有问题的。这个是为什么呢？</p>
<p>在我们的范例中，作为实参的闭包包含一个return语句。闭包返回true，就会导致while循环继续处理列表中的下一个项目。</p>
<p>可以看一下<code>each</code>的实现方式</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Iterator<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">each</span><span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>T<span class="token operator">></span> self<span class="token punctuation">,</span> <span class="token annotation punctuation">@ClosureParams</span><span class="token punctuation">(</span>FirstGenericType<span class="token operator">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> Closure closure<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>self<span class="token operator">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Object arg <span class="token operator">=</span> self<span class="token operator">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            closure<span class="token operator">.</span><span class="token function">call</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> self<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到return是指返回的<code>closure.call()</code>但是外层循环还是在的，并不能直接终止循环，因此最终所有的数都会跑一边，这个是一个比较需要注意的地方，在使用<code>each</code>进行迭代的时候一定要注意哦！</p>
<h1 id="高级闭包"><a href="#高级闭包" class="headerlink" title="高级闭包"></a>高级闭包</h1><blockquote>
<p>假设某家超时使用特殊的商品价格来吸引新客户，以及维护已经有的客户。在一周内，也许早餐谷类视频的价格优惠1/3；在另一周内，优惠政策可能变化，化妆品销售按照买一送一的方式进行销售。在这种优惠政策经常变化的环境中，需要某种灵活的方式来定义这些“业务规则”，并且能够灵活的修改和调整。</p>
<p>此处的思路来源<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20428688">多范式编程</a>方式，这是Groovy的一个非常重要的特性。借助更高级的函数，函数编程范式综合了多台、组合以及计算模式。</p>
</blockquote>
<h2 id="简单闭包"><a href="#简单闭包" class="headerlink" title="简单闭包"></a>简单闭包</h2><p>以前，把闭包描述为一个代码块。闭包实现参数化更加有价值，可以被引用，可以被当做参数传入方法，以及可以与call消息一起被调用。</p>
<p>范例：计算两个数值参数的乘积</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println <span class="token string">"multiply(3,4) = $&amp;#123;multiply(3,4)&amp;#125;"</span>
println <span class="token string">"multiply(3.4,5.6) = $&amp;#123;multiply(3.4,5.6)&amp;#125;"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于闭包可以引用对象的状态。</p>
<p>范例：作用域和闭包</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> multiplier <span class="token operator">=</span> <span class="token number">2</span> 
<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span> 
        <span class="token keyword">return</span> x <span class="token operator">*</span> multiplier
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
println <span class="token string">"multiply(3) = $&amp;#123;multiply(3)&amp;#125;"</span>
println <span class="token string">"multiply(5.6) = $&amp;#123;multiply(5.6)&amp;#125;"</span>

multiplier <span class="token operator">=</span> <span class="token number">3</span>

println <span class="token string">"multiply(3) = $&amp;#123;multiply(3)&amp;#125;"</span>
println <span class="token string">"multiply(5.6) = $&amp;#123;multiply(5.6)&amp;#125;"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在闭包定义范围内的变量可以从闭包代码内访问。</p>
<p>闭包是可以将另一个闭包返回的，类似一个二阶的函数</p>
<p>范例：闭包返回值</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> add <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> subtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> divide <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">/</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> arithmetic <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    arith <span class="token operator">-></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>arith<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'ADD'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> add
            <span class="token keyword">case</span> <span class="token string">'SUBTRACT'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> subtract
            <span class="token keyword">case</span> <span class="token string">'MULTIPLY'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> multiply
            <span class="token keyword">case</span> <span class="token string">'DIVIDE'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> divide
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> add
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> addOperation <span class="token operator">=</span> <span class="token function">arithmetic</span><span class="token punctuation">(</span><span class="token string">'ADD'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> mulOperation <span class="token operator">=</span> <span class="token function">arithmetic</span><span class="token punctuation">(</span><span class="token string">'MULTIPLY'</span><span class="token punctuation">)</span>

println <span class="token string">"addOperation(3,4) = $&amp;#123;addOperation(3,4)&amp;#125;"</span>
println <span class="token string">"mulOperation(3,4) = $&amp;#123;mulOperation(3,4)&amp;#125;"</span>
println <span class="token function">arithmetic</span><span class="token punctuation">(</span><span class="token string">'DIVIDE'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="部分应用"><a href="#部分应用" class="headerlink" title="部分应用"></a>部分应用</h2><p>在上面的范例2中，multiply闭包计算一个参数和内部变量multiplier的乘积。现在，如果把multiplier作为闭包的参数，这个闭包返回multiply闭包，后者计算自己的参数与multiplier的成绩，这就是闭包部分应用的范例。</p>
<p>范例：partial applicaiton</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> tripple <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> quadroup <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> twelve <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
println <span class="token function">tripple</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
println <span class="token function">quadroup</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
println <span class="token function">twelve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>**注意：表达式<code>multiply.curry(3)</code>**表示把参数乘以3的闭包。然后，被返回的闭包使用一个参数进行调用。在数学家Haskell Curry之后，闭包的部分应用被称为修正。闭包<code>triple</code>的定义如下：</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> triple <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    y <span class="token operator">-></span>
          <span class="token keyword">return</span> <span class="token number">3</span> <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，第一个参数被删除，所有出现第一个参数的地方使用数字3来替代。</p>
<p>加法和惩罚被称为可交换操作。这意味着<code>A+B = B+A and A*B = B*A</code>。但是减法和除法是不可交换的操作。我们可以事件类似于multiply的闭包。</p>
<p>范例：实现可交换操作</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> rSubtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    y<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> lSubtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> subtract10 <span class="token operator">=</span> rSubtract<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> subractFrom20 <span class="token operator">=</span> lSubtract<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>

println <span class="token function">subtract10</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
println <span class="token function">subractFrom20</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于修正闭包的一个重点是：<code>curry</code>方法的实参数量绝对不能超过该必报所需的实参实际数量。比如该闭包有有三个参数，则调用curry方法时，可以使用零个，一个，两个，或者三个实参。</p>
<p>部分应用可以被认为是一种简化形式，是个复杂任务可以被分解为多个子任务。</p>
<h2 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h2><p>结构化顺序的一种组织方式是顺序执行多个任务。通常而言，每部分任务被分别设计和实现。在此，也许认为，一个闭包标识需要执行的某个简单任务。适用组合概念进行任务合并，可以非常容易构造出复杂的任务。并且，借助不同的祝贺方式，可以较快的创建超时所需要的新任务，本文开篇所述案例。</p>
<p>范例：闭包组合</p>
<p>范例演示了composition闭包，这个闭包有两个参数f和g，两个参数代表闭包，把闭包g应用到x比如<code>g(x)</code>，把闭包f应用到处理结果比如<code>(fg(x))</code></p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> composition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        println <span class="token string">"f:$&amp;#123;f.class&amp;#125; g: $&amp;#123;g.class&amp;#125; x: $&amp;#123;x.class&amp;#125;"</span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> composition2 <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> triple <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> quadroup <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> twelveTimes <span class="token operator">=</span> composition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>triple<span class="token punctuation">,</span> quadroup<span class="token punctuation">)</span>
<span class="token keyword">def</span> multiplyCompo <span class="token operator">=</span> composition2<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>triple<span class="token punctuation">,</span>quadroup<span class="token punctuation">)</span>

println <span class="token string">"twelveTimes(12) = $&amp;#123;twelveTimes(12)&amp;#125;"</span> <span class="token comment" spellcheck="true">//(3*(4 * 12)) = 144</span>
println <span class="token string">"multiplyCompo(12) = $&amp;#123;multiplyCompo(12)&amp;#125;"</span> <span class="token comment" spellcheck="true">// 3*12 * 4*12 = 1728</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>闭包<code>triple</code>有一个参数，并把这个参数与3相乘。闭包<code>twelveTimes</code>是闭包<code>tripe和quadroup</code>的组合。结果是，闭包<code>twelveTimes</code>把参数乘以4，然后把乘法结果与3相乘。</p>
<p>范例：组合与集合</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> composition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> triple <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> quadroup <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> twelveTimes <span class="token operator">=</span> composition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>triple<span class="token punctuation">,</span>quadroup<span class="token punctuation">)</span>

<span class="token keyword">def</span> table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">.</span>collect<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    element <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">twelveTimes</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
println <span class="token string">"tabl = $table "</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="计算模式"><a href="#计算模式" class="headerlink" title="计算模式"></a>计算模式</h2><blockquote>
<p>介绍一种机制，是的闭包包含一种计算模式。</p>
</blockquote>
<p>范例是对列表中的每个元素按照某中形式进行转换。这种转换通常被命名为<code>map</code>。</p>
<p>范例：映射</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//map closure</span>
<span class="token keyword">def</span> map <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    clos<span class="token punctuation">,</span> list <span class="token operator">-></span>
        <span class="token keyword">return</span> list<span class="token operator">.</span><span class="token function">collect</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//composition closure</span>
<span class="token keyword">def</span> compositon <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f <span class="token punctuation">,</span>g <span class="token punctuation">,</span>x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> triple <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> quadroup <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> tripleAll <span class="token operator">=</span> map<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>triple<span class="token punctuation">)</span>


<span class="token keyword">def</span> table <span class="token operator">=</span> <span class="token function">tripleAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
println table
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析：</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//实际的trpleAll将是一个CurryedClosure</span>
<span class="token comment" spellcheck="true">//quadroup的结构</span>
quadroup <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    list <span class="token operator">-></span> 
          <span class="token keyword">return</span> list<span class="token operator">.</span>collect<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              element <span class="token operator">-></span>
                  <span class="token keyword">return</span> <span class="token number">3</span> <span class="token operator">*</span> element 
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于映射的一个等级模式是，如果把闭包（比如f）映射到列表x，然后把闭包（比如g）应用到前一个闭包的处理结果。那么上述过程就等价于把g和f的组合应用到这个列表x。</p>
<p>范例：处理等价关系</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//map closure</span>
<span class="token keyword">def</span> map <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    clos<span class="token punctuation">,</span> list <span class="token operator">-></span>
        <span class="token keyword">return</span> list<span class="token operator">.</span><span class="token function">collect</span><span class="token punctuation">(</span>clos<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//composition closure</span>
<span class="token keyword">def</span> compositon <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> multiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> triple <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> quadroup <span class="token operator">=</span> multiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> composeMapMap <span class="token operator">=</span> compositon<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>map<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>triple<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>quadroup<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> table <span class="token operator">=</span> <span class="token function">composeMapMap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// each element * 4 * 3</span>

println table
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="业务规则"><a href="#业务规则" class="headerlink" title="业务规则"></a>业务规则</h2><blockquote>
<p>现在我们考虑如何计算一个Book的净价，在计算过程要考虑到上品折扣和政府税金，比如增值税。</p>
</blockquote>
<p>关于业务规则的实际实现</p>
<p>范例：净价计算</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> name
    <span class="token keyword">def</span> author
    <span class="token keyword">def</span> price
    <span class="token keyword">def</span> category
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> bk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Groovy'</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">'KenB'</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> category<span class="token punctuation">:</span> <span class="token string">'CompSci'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 参数列表初始化</span>

<span class="token keyword">def</span> discountRate <span class="token operator">=</span> <span class="token number">0.1</span>
<span class="token keyword">def</span> taxRate <span class="token operator">=</span> <span class="token number">0.17</span>

<span class="token keyword">def</span> rMultiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    y <span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> lMultiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> composition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span>g<span class="token punctuation">,</span>x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> calDiscounteedPrice <span class="token operator">=</span> rMultiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>discountRate<span class="token punctuation">)</span>
<span class="token keyword">def</span> calTax <span class="token operator">=</span> rMultiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> taxRate<span class="token punctuation">)</span>
<span class="token keyword">def</span> calcNetPrice <span class="token operator">=</span> composition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>calTax<span class="token punctuation">,</span>calDiscounteedPrice<span class="token punctuation">)</span>

<span class="token keyword">def</span> netPrice <span class="token operator">=</span> <span class="token function">calcNetPrice</span><span class="token punctuation">(</span>bk<span class="token operator">.</span>price<span class="token punctuation">)</span>

println <span class="token string">"netPrice = $&amp;#123;netPrice&amp;#125;"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>范例：有上限折扣</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> name
    <span class="token keyword">def</span> author
    <span class="token keyword">def</span> price
    <span class="token keyword">def</span> category
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> bk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Groovy'</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">'KenB'</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> category<span class="token punctuation">:</span> <span class="token string">'CompSci'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> discountRate <span class="token operator">=</span> <span class="token number">0.1</span>
<span class="token keyword">def</span> taxRate <span class="token operator">=</span> <span class="token number">0.17</span>
<span class="token keyword">def</span> maxDiscount <span class="token operator">=</span> <span class="token number">3</span>

<span class="token keyword">def</span> rMultiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    y<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> lMultiply <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> subtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> rSubtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    y<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> lSubtract <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">-</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> min <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">&lt;</span> y <span class="token operator">?</span> x <span class="token punctuation">:</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> id <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x <span class="token operator">-></span>
        <span class="token keyword">return</span> x
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> composition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> bComposition <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    h<span class="token punctuation">,</span> f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> calcDiscount <span class="token operator">=</span> rMultiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>discountRate<span class="token punctuation">)</span>
<span class="token keyword">def</span> calcActuralDiscount <span class="token operator">=</span> bComposition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> calcDiscount<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token keyword">def</span> calcDiscountedPrice <span class="token operator">=</span> bComposition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>subtract<span class="token punctuation">,</span> id<span class="token punctuation">,</span> calcActuralDiscount<span class="token punctuation">)</span>
<span class="token keyword">def</span> calcTax <span class="token operator">=</span> rMultiply<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> taxRate<span class="token punctuation">)</span>
<span class="token keyword">def</span> calcNetPrice <span class="token operator">=</span> composition<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>calcTax<span class="token punctuation">,</span>calcDiscountedPrice<span class="token punctuation">)</span>

println <span class="token string">"bk.price : $bk.price"</span>

<span class="token keyword">def</span> netPrice <span class="token operator">=</span> <span class="token function">calcNetPrice</span><span class="token punctuation">(</span>bk<span class="token operator">.</span>price<span class="token punctuation">)</span>

println <span class="token string">"netprice = $netPrice"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>以上范例开发了大量非常有价值的闭包，可以非常灵活的合并使用。因此，有必要把这些闭包都打包到一个类中去，这样更加容易引入到应用程序。</p>
<pre class="line-numbers language-groovyy"><code class="language-groovyy">abstract class Functor &#123;
    public static Closure bAdd = &#123;
        x, y -> return x + y
    &#125;

    public static Closure rAdd = &#123;
        y, x -> return x + y
    &#125;
    
    public static Closure bSubtract = &#123;
        x , y -> return x - y
    &#125;
    //blabla
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个类包含了算数的闭包。</p>
<h2 id="闭包与协程"><a href="#闭包与协程" class="headerlink" title="闭包与协程"></a>闭包与协程</h2><p>调用一个函数或方法会在程序的执行序列创建一个新的作用域.我们会在一个入口点进入函数.在方法完成之后,回到调用者的作用域.</p>
<p>协程(Coroutine)则支持多个入口点,每个入口点都是上次挂起调用的位置.我们可以进入一个函数,执行部分代码,挂起,在回到调用者的上下文或作用域内执行一些代码.之后我们可以在挂起的地方恢复该函数的执行.</p>
<p>写成对于实现某些特殊的逻辑或算法非常方便,比如用着生产者-消费者问题中.生产者会接受一些输入,对输入做一些厨师处理,通知消费者拿走处理过的值并做进一步计算,并输出或存出结果.消费者处理它那部分工作,完成之后通知生产者以获取更多输入.</p>
<p>在Java中,<code>wait() and notify()</code>与多线程借个使用,可以实现协程.闭包会让人产生”协程是在一个线程中执行”的感觉or错觉.</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">def</span> <span class="token function">iterate</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token number">1</span><span class="token operator">.</span><span class="token function">upto</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        println <span class="token string">"In iterate with value $&amp;#123;it&amp;#125;"</span>
        <span class="token function">closure</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

println <span class="token string">"Calling iterate"</span>
total <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    total <span class="token operator">+=</span> it
    println <span class="token string">"In closure total so far is $&amp;#123;total&amp;#125;"</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
println <span class="token string">"Done"</span>
<span class="token comment" spellcheck="true">/**
每次调用闭包,我们都会从上一次调用中回复total的值.  //可是我并没有从例子中看出什么是协程????
*/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>协程不是进程或线程，其执行过程更类似于子例程，或者说不带返回值的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/4127405">函数调用</a>。 协程还是比较复杂,嗯后续在研究研究.</p>
<h2 id="闭包委托"><a href="#闭包委托" class="headerlink" title="闭包委托"></a>闭包委托</h2><p>Groovy的闭包支持方法委托,而且提供了方法分派能力.</p>
<p><code>this,owner and delegate</code>是闭包的三个属性,用于确定有那个对象处理闭包内的方法调用,一般而言,<code>delegate 会被设置为 owner</code>,但是对其进行修改,可以有非常好的元编程能力.</p>
<p>利用闭包委托,可以更好的写出DSL,将在DSL好好的讲述本内容.</p>
<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><p>有关函数式编程，可参考阮一峰老师的博客，在这里引用阮一峰老师的博客，特此注明，并非常感谢老师能够出一片教程给大家科普一下。</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2017/02/fp-tutorial.html">函数式编程入门教程–阮一峰</a></p>
<p>ps:自己的一些理解</p>
<p>对于函数式编程中的柯里化，对应高中数学的只是，其实就是函数的一个组合。为了组合函数，需要将多个多参数函数转换成单参数函数。</p>
<p>举个🌰：<br>$$<br>z = x + y<br>$$</p>
<p>$$<br>z = x * y<br>$$</p>
<p>如果我想得到一个复合函数使得2-&gt;映射到8，计算过程为<code>2 * 3 + 2</code></p>
<p>那么我怎么得到这个函数呢？定义这个映射为f<br>$$<br>f(x) = x * 3  +  2<br>$$<br>那么在程序中我们怎么体现呢</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//这里的函数都是以闭包形式表示的准确来说这不是一个"方法",而是一个闭包的对象</span>
<span class="token comment" spellcheck="true">//首先我们需要一个加法函数，这个加法函数是一个广义的</span>
<span class="token keyword">def</span> add <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//然后我们需要一个乘法函数,同样是一个广义的</span>
<span class="token keyword">def</span> multiple <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    x<span class="token punctuation">,</span> y <span class="token operator">-></span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//然后我们定义一个组合,这个组合是嵌套函数,两个映射f,g和一个自变量x</span>
<span class="token keyword">def</span> compose <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> x <span class="token operator">-></span>
        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//add.curry(2)  :  y = 2 + z</span>
<span class="token comment" spellcheck="true">//multiple.curry(2)  : z = 3 * x 注:这里只是为了方便,变量名并不代表带入关系</span>
<span class="token comment" spellcheck="true">//compose.curry(add2,multiple3) = : z = 2 + (3 * x)</span>
<span class="token keyword">def</span> add2 <span class="token operator">=</span> add<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> multiple3 <span class="token operator">=</span> multiple<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> addAndMultiple <span class="token operator">=</span> compose<span class="token operator">.</span><span class="token function">curry</span><span class="token punctuation">(</span>add2<span class="token punctuation">,</span>multiple3<span class="token punctuation">)</span>
println <span class="token function">addAndMultiple</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"287314570e232c0e401f","clientSecret":"bb261daec807b4f3dd21e7161f4fbbc7f1a546ab","repo":"hefuduo.github.io","owner":"hefuduo","admin":"hefuduo"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
	
	</div>
  <a type="button" href="/2017/08/22/2017-08-22-groovy闭包-2017/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/3/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Android基础/">Android基础<span>2</span></a></li>
		
			<li><a href="/categories/DevOps/">DevOps<span>3</span></a></li>
		
			<li><a href="/categories/安全/">安全<span>1</span></a></li>
		
			<li><a href="/categories/源码阅读/">源码阅读<span>10</span></a></li>
		
			<li><a href="/categories/编程语言/">编程语言<span>7</span></a></li>
		
			<li><a href="/categories/逆向/">逆向<span>2</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/逆向/">逆向<span>2</span></a></li>
		
			<li><a href="/tags/C/">C++<span>1</span></a></li>
		
			<li><a href="/tags/DSL/">DSL<span>1</span></a></li>
		
			<li><a href="/tags/源码分析/">源码分析<span>2</span></a></li>
		
			<li><a href="/tags/Gradle/">Gradle<span>1</span></a></li>
		
			<li><a href="/tags/Data-Structure/">Data Structure<span>8</span></a></li>
		
			<li><a href="/tags/软件工程/">软件工程<span>2</span></a></li>
		
			<li><a href="/tags/Android-四大组件/">-Android -四大组件<span>1</span></a></li>
		
			<li><a href="/tags/Java/">Java<span>5</span></a></li>
		
			<li><a href="/tags/maven/">maven<span>1</span></a></li>
		
			<li><a href="/tags/Android/">Android<span>4</span></a></li>
		
			<li><a href="/tags/图片库/">图片库<span>2</span></a></li>
		
			<li><a href="/tags/open-source-library/">open source library<span>2</span></a></li>
		
			<li><a href="/tags/Groovy/">Groovy<span>5</span></a></li>
		
			<li><a href="/tags/Android-Layout/">-Android -Layout<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/01/28/2020-01-28-Android布局-ConstrainLayout/"  title="安卓布局值ConstrainLayout详解" ><i class="fa fa-file-o"></i></a>
      </li>
    
      <li>
        <a href="/2020/01/12/2020-01-12-Android逆向学习2-2020/"  title="Android Dalvik虚拟机" ><i class="fa fa-file-o"></i>安卓逆向学习2</a>
      </li>
    
      <li>
        <a href="/2020/01/11/2020-01-11-Android逆向学习1-2020/"  title="初识逆向,如何分析Android应用程序" ><i class="fa fa-file-o"></i>安卓逆向学习1</a>
      </li>
    
      <li>
        <a href="/2019/11/25/2019-12-03-Java关于内联函数与性能优化-2019/"  title="函数内联" ><i class="fa fa-file-o"></i>内联函数与性能优化</a>
      </li>
    
      <li>
        <a href="/2019/11/14/2019-11-14-Java集合分析8-2019/"  title="排序" ><i class="fa fa-file-o"></i>Java集合分析8</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/wzpan/hexo-theme-freemind" title="Freemind's Github repository." target="_blank">Freemind</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/kristopolous/BOOTSTRA.386" title="BOOTSTRA.386's Github repository." target="_blank">BOOTSTRA.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/blackshow/hexo-theme-freemind.386" title="Freemind.386's Github repository." target="_blank">Freemind.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/blackshow" title="My Github account." target="_blank">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2022 Leo He
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
